# -*- coding: utf-8 -*-
"""
ะะฐััะธะฝะณ ะพัะฒะตัะฐ ะพั Claude
ะะทะฒะปะตัะตะฝะธะต SEO_TITLE, META_DESC, ะฟะพะดััะตั ัะปะพะฒ
"""
import re


def parse_article_response(article_html, keyword, company_data, min_words, max_words):
    """
    ะะฐััะธั ะพัะฒะตั ะพั Claude ะธ ะธะทะฒะปะตะบะฐะตั ะผะตัะฐะดะฐะฝะฝัะต
    
    Args:
        article_html: HTML ััะฐััะธ ะพั Claude
        keyword: ะะปััะตะฒะพะต ัะปะพะฒะพ
        company_data: ะะฐะฝะฝัะต ะบะพะผะฟะฐะฝะธะธ
        min_words: ะะธะฝะธะผัะผ ัะปะพะฒ
        max_words: ะะฐะบัะธะผัะผ ัะปะพะฒ
        
    Returns:
        dict: {
            'html': 'ะัะธัะตะฝะฝัะน HTML',
            'seo_title': 'SEO ะทะฐะณะพะปะพะฒะพะบ',
            'meta_description': 'ะะตัะฐ ะพะฟะธัะฐะฝะธะต',
            'word_count': 1234
        }
    """
    company_name = company_data.get('company_name', 'ะะฐัะฐ ะบะพะผะฟะฐะฝะธั')
    company_city = company_data.get('company_city', '')
    company_phone = company_data.get('company_phone', '')
    
    # ะะทะฒะปะตะบะฐะตะผ SEO_TITLE
    seo_title = ""
    title_match = re.search(r'SEO_TITLE:\s*(.+?)(?:\n|$)', article_html, re.IGNORECASE)
    if title_match:
        seo_title = title_match.group(1).strip()
        # ะัะธัะฐะตะผ ะพั markdown ะธ ัะฟะตััะธะผะฒะพะปะพะฒ
        seo_title = seo_title.replace('**', '').replace('*', '').replace('#', '').strip()
        # ะฃะดะฐะปัะตะผ ะธะท HTML
        article_html = re.sub(r'SEO_TITLE:\s*.+?(?:\n|$)', '', article_html, flags=re.IGNORECASE)
    
    # ะคะะะะะญะ: ะตัะปะธ SEO_TITLE ะฟัััะพะน, ะณะตะฝะตัะธััะตะผ ะธะท keyword
    if not seo_title:
        import random
        from datetime import datetime
        current_year = datetime.now().year
        
        # ะะตะนััะฒะธัะตะปัะฝะพ ะธะฝัะตัะตัะฝัะต ะทะฐะณะพะปะพะฒะบะธ ั ะฟัะฐะฒะธะปัะฝัะผ ัะบะปะพะฝะตะฝะธะตะผ
        templates = [
            f"{keyword}: ะฟะพัะฐะณะพะฒะฐั ะธะฝััััะบัะธั {current_year}",
            f"{keyword} โ ะฟัะฐะบัะธัะตัะบะพะต ััะบะพะฒะพะดััะฒะพ",
            f"{keyword}: ะฒะธะดั, ัะตะฝั, ัะพะฒะตัั ัะบัะฟะตััะพะฒ",
            f"{keyword} โ ััะพ ะฝัะถะฝะพ ะทะฝะฐัั ะฟะตัะตะด ะฟะพะบัะฟะบะพะน",
            f"{keyword}: ััะฐะฒะฝะตะฝะธะต ะธ ะฒัะฑะพั {current_year}",
            f"{keyword}: ะฟัะพัะตััะธะพะฝะฐะปัะฝัะน ะฒัะฑะพั ะทะฐ 5 ะผะธะฝัั",
            f"{keyword} โ ะฟะพะปะฝัะน ะพะฑะทะพั ะธ ัะตะบะพะผะตะฝะดะฐัะธะธ",
            f"ะะฐะบ ะฒัะฑัะฐัั {keyword}: ะณะธะด ะดะปั ะฟะพะบัะฟะฐัะตะปั",
            f"{keyword} ะฒ {current_year}: ะฐะบััะฐะปัะฝัะน ะพะฑะทะพั",
            f"{keyword}: ัะฐัะฐะบัะตัะธััะธะบะธ, ะผะพะฝัะฐะถ, ัะตะฝั"
        ]
        
        seo_title = random.choice(templates)
        
        # ะัะธัะฐะตะผ ะพั ะฝะตะดะพะฟัััะธะผัั ัะธะผะฒะพะปะพะฒ
        seo_title = re.sub(r'[*/\\|@#$%^&]', '', seo_title)
        
        # ะะฑัะตะทะฐะตะผ ะดะพ 60 ัะธะผะฒะพะปะพะฒ ะตัะปะธ ัะปะธัะบะพะผ ะดะปะธะฝะฝัะน
        if len(seo_title) > 60:
            seo_title = seo_title[:57] + "..."
        
        print(f"โ๏ธ SEO_TITLE ะฝะต ะฝะฐะนะดะตะฝ ะฒ ะพัะฒะตัะต, ัะพะทะดะฐะฝ ะฐะฒัะพะผะฐัะธัะตัะบะธ: {seo_title}")
    
    # ะะทะฒะปะตะบะฐะตะผ META_DESC
    meta_desc = ""
    desc_match = re.search(r'META_DESC:\s*(.+?)(?:\n|$)', article_html, re.IGNORECASE)
    if desc_match:
        meta_desc = desc_match.group(1).strip()
        # ะัะธัะฐะตะผ ะพั markdown ะธ ัะฟะตััะธะผะฒะพะปะพะฒ
        meta_desc = meta_desc.replace('**', '').replace('*', '').replace('#', '').strip()
        # ะฃะดะฐะปัะตะผ ะธะท HTML
        article_html = re.sub(r'META_DESC:\s*.+?(?:\n|$)', '', article_html, flags=re.IGNORECASE)
    
    # ะคะะะะะญะ: ะตัะปะธ META_DESC ะฟัััะพะน, ะณะตะฝะตัะธััะตะผ ะธะท keyword
    if not meta_desc:
        import random
        
        templates = [
            f"ะะต ะฟะพะบัะฟะฐะนัะต {keyword}, ะฟะพะบะฐ ะฝะต ะฟัะพัะธัะฐะตัะต ััะพ! ะะฐัะบััะฒะฐะตะผ ัะตะบัะตัั ะฒัะฑะพัะฐ, ะบะพัะพััะต ัะบััะฒะฐัั ะฟัะพะดะฐะฒัั. ะงะตััะฝัะต ะพัะทัะฒั ะธ ัะตะฝั",
            f"ะกัะฐะฒะฝะธะปะธ ะฒัะต ะฒะธะดั {keyword} ะฝะฐ ััะฝะบะต โ ัะตะทัะปััะฐัั ะฒะฐั ัะดะธะฒัั. ะฃะทะฝะฐะนัะต, ะณะดะต ะฟะตัะตะฟะปะฐัะฐ, ะฐ ะณะดะต ัะตะฐะปัะฝะฐั ะฒัะณะพะดะฐ",
            f"{keyword}: ััะพ ะฝัะถะฝะพ ะทะฝะฐัั ะฟะตัะตะด ะฟะพะบัะฟะบะพะน? ะัะพัะตััะธะพะฝะฐะปัะฝัะน ัะฐะทะฑะพั ะพั ะ ะดะพ ะฏ. ะกัะบะพะฝะพะผััะต ะฒัะตะผั ะธ ะดะตะฝัะณะธ",
            f"ะัะฑะพั {keyword} ะทะฐ 5 ะผะธะฝัั: ะฟะพัะฐะณะพะฒัะน ัะตะบ-ะปะธัั + ัะตะฐะปัะฝัะต ัะตะฝั. ะะตะท ะฒะพะดั ะธ ัะตะบะปะฐะผั โ ัะพะปัะบะพ ัะฐะบัั",
            f"ะะฐััะตัะฐ ัะฐััะบะฐะทะฐะปะธ ะฟัะฐะฒะดั ะฟัะพ {keyword}. ะะฐ ััะผ ัะบะพะฝะพะผะธัั ะฝะตะปัะทั, ะฐ ะณะดะต ะฟะตัะตะฟะปะฐัะฐ. ะะบััะฐะปัะฝัะต ัะตะฝั ะธ ะพัะทัะฒั"
        ]
        
        meta_desc = random.choice(templates)
        
        # ะัะธัะฐะตะผ ะพั ะฝะตะดะพะฟัััะธะผัั ัะธะผะฒะพะปะพะฒ
        meta_desc = re.sub(r'[*/\\|@#$%^&]', '', meta_desc)
        
        # ะะฑัะตะทะฐะตะผ ะดะพ 155 ัะธะผะฒะพะปะพะฒ
        if len(meta_desc) > 155:
            meta_desc = meta_desc[:152] + "..."
        
        print(f"โ๏ธ META_DESC ะฝะต ะฝะฐะนะดะตะฝ ะฒ ะพัะฒะตัะต, ัะพะทะดะฐะฝ ะฐะฒัะพะผะฐัะธัะตัะบะธ: {meta_desc}")
    
    # ะัะธัะฐะตะผ ะปะธัะฝะธะต ะฟััััะต ัััะพะบะธ ะฒ ะบะพะฝัะต
    article_html = article_html.strip()
    
    # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    # ะฃะะะะะะะ "ะะซะกะะะขะะะฌะะะะ ะะะะฆะะกะกะ" CLAUDE
    # Claude ะธะฝะพะณะดะฐ ะฒะฟะธััะฒะฐะตั ัะฒะพะธ ัะฐัััะถะดะตะฝะธั ะฟะตัะตะด ััะฐัััะน
    # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    
    # ะฃะดะฐะปัะตะผ ะฒัั ะะ ะฟะตัะฒะพะณะพ HTML-ัะตะณะฐ (ะผััะพั Claude ะฟะตัะตะด ััะฐัััะน)
    first_tag = re.search(r'<(?:h[1-6]|div|article|section|p\s)', article_html, re.IGNORECASE)
    if first_tag and first_tag.start() > 50:
        removed_text = article_html[:first_tag.start()].strip()
        if removed_text:
            print(f"๐งน ะฃะดะฐะปัะฝ ะผััะพั ะฟะตัะตะด ััะฐัััะน ({len(removed_text)} ัะธะผะฒะพะปะพะฒ):")
            print(f"   ยซ{removed_text[:150]}...ยป")
        article_html = article_html[first_tag.start():]
    
    # ะฃะดะฐะปัะตะผ ัะธะฟะธัะฝัะต ััะฐะทั Claude ะฒ ะฝะฐัะฐะปะต/ัะตัะตะดะธะฝะต ัะตะบััะฐ
    claude_phrases = [
        r'ะฏ ะฟะพะผะพะณั ะฒะฐะผ ัะพะทะดะฐัั[^.]*\.',
        r'ะฏ ะฟัะพะฒะตะดั ะธััะปะตะดะพะฒะฐะฝะธะต[^.]*\.',
        r'ะกะฝะฐัะฐะปะฐ ะฟัะพะฒะตะดั ะธััะปะตะดะพะฒะฐะฝะธะต[^.]*\.',
        r'ะขะตะฟะตัั ัะพะทะดะฐะผ[^.]*ััะฐััั[^.]*:?\s*',
        r'ะะฐ ะพัะฝะพะฒะต ะฟัะพะฒะตะดะตะฝะฝะพะณะพ ะธััะปะตะดะพะฒะฐะฝะธั[^.]*:?\s*',
        r'ะะฐ ะพัะฝะพะฒะต ัะพะฑัะฐะฝะฝะพะน ะธะฝัะพัะผะฐัะธะธ[^.]*:?\s*',
        r'ะะฐัะฝั ั ะธััะปะตะดะพะฒะฐะฝะธั[^.]*\.',
        r'ะะฐะฒะฐะนัะต ัะพะทะดะฐะดะธะผ[^.]*\.',
        r'ะกะพะทะดะฐะผ ัะบัะฟะตััะฝัั ััะฐััั[^.]*:?\s*',
    ]
    for phrase in claude_phrases:
        article_html = re.sub(phrase, '', article_html, flags=re.IGNORECASE)
    
    # ะฃะดะฐะปัะตะผ ะฟะพะธัะบะพะฒัะต ะทะฐะฟัะพัั Claude (ัััะพะบะธ ะฑะตะท HTML, ะฟะพัะพะถะธะต ะฝะฐ ะบะปััะตะฒัะต ััะฐะทั)
    # ะะฐััะตัะฝ: ัััะพะบะธ ะธะท 3-8 ัะปะพะฒ ะฑะตะท HTML-ัะตะณะพะฒ, ะธะดััะธะต ะฟะพะดััะด
    lines = article_html.split('\n')
    cleaned_lines = []
    skip_count = 0
    for i, line in enumerate(lines):
        stripped = line.strip()
        # ะัะพะฟััะบะฐะตะผ ะฟััััะต ัััะพะบะธ
        if not stripped:
            cleaned_lines.append(line)
            continue
        # ะกััะพะบะฐ ะฑะตะท HTML-ัะตะณะพะฒ, 3-10 ัะปะพะฒ, ะฟะพัะพะถะฐ ะฝะฐ ะฟะพะธัะบะพะฒัะน ะทะฐะฟัะพั
        if (not re.search(r'<[a-z]', stripped, re.IGNORECASE) and
            3 <= len(stripped.split()) <= 12 and
            len(stripped) < 200 and
            not stripped.endswith(('.', '!', '?', ':', ';')) and
            not stripped.startswith(('โ', '-', 'โข', 'โ', 'โ', 'โ'))):
            skip_count += 1
            print(f"๐งน ะฃะดะฐะปะตะฝะฐ ัััะพะบะฐ-ะทะฐะฟัะพั: ยซ{stripped}ยป")
            continue
        cleaned_lines.append(line)
    
    if skip_count > 0:
        print(f"๐งน ะฃะดะฐะปะตะฝะพ {skip_count} ัััะพะบ ะฟะพะธัะบะพะฒัั ะทะฐะฟัะพัะพะฒ")
    article_html = '\n'.join(cleaned_lines)
    
    # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    # ะฃะะะะะะะ ะะะะะฃะจะะ ะะะะะะะะะะะ [ะะะะะะะะะะะ: ...]
    # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    
    # ะฃะดะฐะปัะตะผ ะฑะปะพะบะธ [ะะะะะะะะะะะ: ...] ะฒะผะตััะต ั Alt, ะคะพัะผะฐั, ะะพะทะธัะธั
    article_html = re.sub(
        r'\[ะะะะะะะะะะะ:[^\]]*\]\s*(?:\n\s*(?:Alt|ะคะพัะผะฐั|ะะพะทะธัะธั|Format|Position):[^\n]*)*',
        '', article_html, flags=re.IGNORECASE
    )
    # ะฃะดะฐะปัะตะผ ะพััะฐะฒัะธะตัั ัััะพะบะธ Alt:, ะคะพัะผะฐั:, ะะพะทะธัะธั: ะตัะปะธ ะธะดัั ะพัะดะตะปัะฝะพ
    article_html = re.sub(r'^\s*Alt:\s*[ยซ"][^ยป"]*[ยป"]\s*$', '', article_html, flags=re.MULTILINE)
    article_html = re.sub(r'^\s*ะคะพัะผะฐั:\s*\d+:\d+[^\n]*$', '', article_html, flags=re.MULTILINE)
    article_html = re.sub(r'^\s*ะะพะทะธัะธั:\s*[^\n]*$', '', article_html, flags=re.MULTILINE)
    
    # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    # ะกะะะะขะะะะฆะะฏ HTML โ ัะดะฐะปะตะฝะธะต markdown ะธ ัะฟะตััะธะผะฒะพะปะพะฒ
    # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    
    # ะฃะดะฐะปัะตะผ markdown-ัะฐะทะผะตัะบั ะบะพัะพััั Claude ะธะฝะพะณะดะฐ ะพััะฐะฒะปัะตั
    # **ัะตะบัั** โ <strong>ัะตะบัั</strong>
    article_html = re.sub(r'\*\*([^*]+?)\*\*', r'<strong>\1</strong>', article_html)
    # *ัะตะบัั* โ <em>ัะตะบัั</em>
    article_html = re.sub(r'(?<!\*)\*([^*]+?)\*(?!\*)', r'<em>\1</em>', article_html)
    
    # ะฃะดะฐะปัะตะผ ะพััะฐะฒัะธะตัั ะพะดะธะฝะพัะฝัะต ** ะธ * ะฒ ะฝะฐัะฐะปะต ัััะพะบ (markdown ะทะฐะณะพะปะพะฒะบะธ/ัะฟะธัะบะธ)
    article_html = re.sub(r'^\*\*\s*', '', article_html, flags=re.MULTILINE)
    article_html = re.sub(r'\*\*$', '', article_html, flags=re.MULTILINE)
    
    # ะฃะดะฐะปัะตะผ markdown ะทะฐะณะพะปะพะฒะบะธ (## ัะตะบัั โ ัะถะต ะดะพะปะถะฝั ะฑััั h2, ะฝะพ ะฝะฐ ะฒััะบะธะน ัะปััะฐะน)
    article_html = re.sub(r'^#{1,6}\s+', '', article_html, flags=re.MULTILINE)
    
    # ะฃะดะฐะปัะตะผ ะพััะฐะฒัะธะตัั ัะฟะตััะธะผะฒะพะปั ะฒ ัะตะบััะต (ะฒะฝะต HTML ัะตะณะพะฒ)
    # ะะพ ะะ ะฒะฝัััะธ ัะตะณะพะฒ ะธ ะฐััะธะฑััะพะฒ
    def clean_text_outside_tags(html):
        """ะฃะฑะธัะฐะตะผ ัะฟะตััะธะผะฒะพะปั ัะพะปัะบะพ ะธะท ัะตะบััะพะฒะพะณะพ ะบะพะฝัะตะฝัะฐ, ะฝะต ะธะท ัะตะณะพะฒ"""
        parts = re.split(r'(<[^>]+>)', html)
        cleaned = []
        for part in parts:
            if part.startswith('<'):
                cleaned.append(part)  # ะขะตะณะธ ะฝะต ััะพะณะฐะตะผ
            else:
                # ะฃะฑะธัะฐะตะผ ะพะดะธะฝะพัะฝัะต * / @ # $ ะฒ ะฝะฐัะฐะปะต ะธ ะบะพะฝัะต
                part = re.sub(r'(?<!\w)[*@#$%^&](?!\w)', '', part)
                # ะฃะฑะธัะฐะตะผ ** ะฒ ัะตะบััะต
                part = part.replace('**', '')
                cleaned.append(part)
        return ''.join(cleaned)
    
    article_html = clean_text_outside_tags(article_html)
    
    # ะฃะฑะธัะฐะตะผ ```html ะธ ``` ะพะฑัััะบะธ ะตัะปะธ Claude ะฒะตัะฝัะป ะบะพะด ะฒ ะฑะปะพะบะต
    article_html = re.sub(r'^```html?\s*\n?', '', article_html, flags=re.IGNORECASE)
    article_html = re.sub(r'\n?```\s*$', '', article_html)
    
    # ะฃะดะฐะปัะตะผ URL: ัััะพะบั ะตัะปะธ Claude ะตั ะดะพะฑะฐะฒะธะป
    article_html = re.sub(r'\n?URL:\s*/[^\n]+', '', article_html)
    
    article_html = article_html.strip()
    
    # ะะพะดััะธััะฒะฐะตะผ ัะตะฐะปัะฝะพะต ะบะพะปะธัะตััะฒะพ ัะปะพะฒ (ะฑะตะท HTML ัะตะณะพะฒ)
    word_count = count_words(article_html)
    
    print(f"๐ ะะพะดัััั ัะปะพะฒ:")
    print(f"   โข ะกะธะผะฒะพะปะพะฒ HTML: {len(article_html)}")
    print(f"   โข ะกะปะพะฒ (ัะตะฐะปัะฝัั): {word_count}")
    print(f"   โข ะขัะตะฑัะตััั ะผะธะฝะธะผัะผ: {min_words}")
    print(f"   โข ะขัะตะฑัะตััั ะผะฐะบัะธะผัะผ: {max_words}")
    
    return {
        'html': article_html,
        'seo_title': seo_title,
        'meta_description': meta_desc,
        'word_count': word_count
    }


def count_words(html_text):
    """
    ะะพะดััะธััะฒะฐะตั ัะปะพะฒะฐ ะฒ HTML (ะฑะตะท ัะตะณะพะฒ)
    
    Args:
        html_text: HTML ัะตะบัั
        
    Returns:
        int: ะะพะปะธัะตััะฒะพ ัะปะพะฒ
    """
    # ะฃะดะฐะปัะตะผ ะฒัะต HTML ัะตะณะธ
    text_only = re.sub(r'<[^>]+>', ' ', html_text)
    # ะฃะดะฐะปัะตะผ ะผะฝะพะถะตััะฒะตะฝะฝัะต ะฟัะพะฑะตะปั
    text_only = re.sub(r'\s+', ' ', text_only).strip()
    # ะกัะธัะฐะตะผ ัะปะพะฒะฐ
    return len(text_only.split())
