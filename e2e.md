1. @seo_complex_bot
2.

Dashboard (/start)

  #: 1
  Сценарий: /start новый пользователь
  Ожидание: Welcome-текст + бонус 1500 токенов, reply-клавиатура «Меню / Написать статью /
  Создать
    пост»
  ────────────────────────────────────────
  #: 2
  Сценарий: /start возвращающийся (есть проекты)
  Ожидание: Баланс + статистика + inline-кнопки pipeline
  ────────────────────────────────────────
  #: 3
  Сценарий: /start возвращающийся (0 проектов)
  Ожидание: Баланс + «нет проектов» + кнопка «Мои проекты»
  ────────────────────────────────────────
  #: 4
  Сценарий: Баланс <= 0
  Ожидание: Кнопка «Пополнить баланс» как PRIMARY сверху
  ────────────────────────────────────────
  #: 5
  Сценарий: Нажать «Меню» (reply)
  Ожидание: Возврат к Dashboard
  ────────────────────────────────────────
  #: 6
  Сценарий: Stubs: «Написать статью», «Создать пост», «Профиль», «Токены»
  Ожидание: Сообщение «Coming in Phase F4/F5»

  2. Projects CRUD

  #: 7
  Сценарий: Мои проекты (0 проектов)
  Ожидание: Empty-клавиатура с «Создать проект» (SUCCESS)
  ────────────────────────────────────────
  #: 8
  Сценарий: Создать проект: имя -> компания -> специализация -> сайт (skip)
  Ожидание: Проект создан, кнопка «К проекту»
  ────────────────────────────────────────
  #: 9
  Сценарий: Создать проект: имя < 2 символов
  Ожидание: Ошибка валидации, повтор
  ────────────────────────────────────────
  #: 10
  Сценарий: Создать проект: на шаге сайта ввести «-» или «нет»
  Ожидание: Skip, проект создаётся без сайта
  ────────────────────────────────────────
  #: 11
  Сценарий: Карточка проекта
  Ожидание: Название, платформы, кол-во категорий/публикаций
  ────────────────────────────────────────
  #: 12
  Сценарий: Редактирование: изменить название
  Ожидание: Поле обновлено, возврат к edit-экрану
  ────────────────────────────────────────
  #: 13
  Сценарий: Удаление проекта: подтверждение
  Ожидание: «Вы уверены?» с кнопкой DANGER
  ────────────────────────────────────────
  #: 14
  Сценарий: Удаление проекта: подтвердить
  Ожидание: Проект удалён, возврат к списку
  ────────────────────────────────────────
  #: 15
  Сценарий: Пагинация (нужно >8 проектов)
  Ожидание: Стрелки < 1/2 > работают
  ────────────────────────────────────────
  #: 16
  Сценарий: «Отмена» текстом во время FSM
  Ожидание: FSM сброшена, Dashboard

  3. Categories CRUD

  #: 17
  Сценарий: Категории (0 категорий)
  Ожидание: Empty + «Создать категорию» (SUCCESS)
  ────────────────────────────────────────
  #: 18
  Сценарий: Создать категорию: ввести имя
  Ожидание: Категория создана, карточка
  ────────────────────────────────────────
  #: 19
  Сценарий: Создать категорию: имя < 2 символов
  Ожидание: Ошибка, повтор
  ────────────────────────────────────────
  #: 20
  Сценарий: Карточка категории
  Ожидание: Имя + кнопки (ключевые фразы, описание, цены, настройки контента)
  ────────────────────────────────────────
  #: 21
  Сценарий: Удалить категорию (единственная)
  Ожидание: Удалена, показывается empty-клавиатура
  ────────────────────────────────────────
  #: 22
  Сценарий: Удалить категорию (есть другие)
  Ожидание: Удалена, показывается список оставшихся
  ────────────────────────────────────────
  #: 23
  Сценарий: E24: удалить категорию с расписанием
  Ожидание: QStash расписания отменены, категория удалена

  4. Connections (4 платформы)

  #: 24
  Сценарий: Список подключений (пустой)
  Ожидание: 4 кнопки «+ WordPress/Telegram/VK/Pinterest»
  ────────────────────────────────────────
  #: WordPress
  ────────────────────────────────────────
  #: 25
  Сценарий: WP: URL -> логин -> app_password (валидный)
  Ожидание: Подключение создано, credentials = {url, login, app_password}
  ────────────────────────────────────────
  #: 26
  Сценарий: WP: невалидный URL
  Ожидание: Ошибка, повтор
  ────────────────────────────────────────
  #: 27
  Сценарий: WP: неверный пароль (401)
  Ожидание: «Неверный логин или пароль»
  ────────────────────────────────────────
  #: 28
  Сценарий: WP: сайт не отвечает
  Ожидание: «Сайт не отвечает»
  ────────────────────────────────────────
  #: 29
  Сценарий: WP: «Отмена» на шаге пароля
  Ожидание: Сообщение НЕ удаляется, FSM сброшена
  ────────────────────────────────────────
  #: 30
  Сценарий: WP: E41 тот же сайт в другом проекте
  Ожидание: Подключение создаётся (warn, не block)
  ────────────────────────────────────────
  #: Telegram
  ────────────────────────────────────────
  #: 31
  Сценарий: TG: канал -> токен (бот -- админ канала)
  Ожидание: Подключение, credentials = {bot_token, channel_id}
  ────────────────────────────────────────
  #: 32
  Сценарий: TG: бот не админ канала
  Ожидание: Ошибка с инструкцией
  ────────────────────────────────────────
  #: 33
  Сценарий: TG: невалидный токен
  Ожидание: «Недействительный токен»
  ────────────────────────────────────────
  #: 34
  Сценарий: TG: сообщение с токеном
  Ожидание: Удаляется из чата (security)
  ────────────────────────────────────────
  #: VK
  ────────────────────────────────────────
  #: 35
  Сценарий: VK: токен -> выбор группы
  Ожидание: Список групп inline-кнопками
  ────────────────────────────────────────
  #: 36
  Сценарий: VK: выбрать группу
  Ожидание: Подключение, credentials = {access_token, group_id}
  ────────────────────────────────────────
  #: 37
  Сценарий: VK: невалидный токен
  Ожидание: Ошибка
  ────────────────────────────────────────
  #: 38
  Сценарий: VK: нет групп
  Ожидание: «Нет групп»
  ────────────────────────────────────────
  #: Pinterest
  ────────────────────────────────────────
  #: 39
  Сценарий: Pinterest: нажать «+ Pinterest»
  Ожидание: OAuth URL (stub -- API handler ещё нет)
  ────────────────────────────────────────
  #: Управление
  ────────────────────────────────────────
  #: 40
  Сценарий: Карточка подключения
  Ожидание: Статус, идентификатор, кнопки управления
  ────────────────────────────────────────
  #: 41
  Сценарий: Удалить подключение
  Ожидание: E24: расписания отменены, подключение удалено
  ────────────────────────────────────────
  #: 42
  Сценарий: Удалить подключение с расписанием
  Ожидание: QStash отменён первым

  5. Edge Cases (F1-F2, критические)

  #: 43
  Сценарий: Callback tampering: подменить project_id в callback
  Ожидание: «Проект не найден» (ownership check)
  ────────────────────────────────────────
  #: 44
  Сценарий: FSM conflict: начать создание проекта, потом создание категории
  Ожидание: Первая FSM сбрасывается с уведомлением
  ────────────────────────────────────────
  #: 45
  Сценарий: E42: удалить проект с активными превью
  Ожидание: Токены возвращены перед удалением
  ────────────────────────────────────────
  #: 46
  Сценарий: /cancel во время любой FSM
  Ожидание: FSM сброшена, Dashboard

========================================
PHASE F3: Category Extensions
========================================

  6. Ключевые фразы (keywords.py)

  6.1 Экран ключевых фраз

  #: 47
  Сценарий: Нажать «Ключевые фразы» (0 фраз)
  Ожидание: Экран «Фразы не добавлены» + кнопки «Подобрать» (SUCCESS) и «Загрузить файл»
  ────────────────────────────────────────
  #: 48
  Сценарий: Нажать «Ключевые фразы» (есть кластеры)
  Ожидание: Сводка: N кластеров, M фраз + кнопки «Кластеры / Скачать CSV / Ещё / Загрузить / Удалить кластер / Удалить все»

  6.2 Генерация (KeywordGenerationFSM)

  #: 49
  Сценарий: Подобрать фразы -> ввести товары/услуги (3-1000 символов)
  Ожидание: «Укажите географию» (следующий шаг)
  ────────────────────────────────────────
  #: 50
  Сценарий: Товары/услуги: < 3 символов
  Ожидание: Ошибка валидации «минимум 3 символа», повтор
  ────────────────────────────────────────
  #: 51
  Сценарий: Товары/услуги: > 1000 символов
  Ожидание: Ошибка «максимум 1000 символов», повтор
  ────────────────────────────────────────
  #: 52
  Сценарий: Ввести географию (2-200 символов)
  Ожидание: Экран выбора количества (50/100/150/200)
  ────────────────────────────────────────
  #: 53
  Сценарий: География: < 2 символов
  Ожидание: Ошибка «минимум 2 символа», повтор
  ────────────────────────────────────────
  #: 54
  Сценарий: Выбрать количество (напр. 100)
  Ожидание: Экран подтверждения с ценой (estimate_keywords_cost(100) токенов)
  ────────────────────────────────────────
  #: 55
  Сценарий: Подтвердить генерацию (баланс достаточен)
  Ожидание: Токены списаны, прогресс-сообщения «Получаю фразы... Группирую... Обогащаю...»,
    результат «N кластеров, M фраз»
  ────────────────────────────────────────
  #: 56
  Сценарий: E01: подтвердить генерацию (баланс недостаточен)
  Ожидание: «Недостаточно токенов. Нужно X, у вас Y. [Пополнить]»
  ────────────────────────────────────────
  #: 57
  Сценарий: Отменить генерацию (кнопка «Отмена»)
  Ожидание: FSM сброшена, возврат к карточке категории
  ────────────────────────────────────────
  #: 58
  Сценарий: Pipeline error (AI/DataForSEO сбой во время генерации)
  Ожидание: Возврат токенов (refund), сообщение об ошибке

  6.3 Сохранённые ответы

  #: 59
  Сценарий: Повторная генерация (есть saved products+geography)
  Ожидание: Экран «Использовать сохранённые?» с кнопками «Использовать» / «Начать заново»
  ────────────────────────────────────────
  #: 60
  Сценарий: Нажать «Использовать сохранённые»
  Ожидание: Пропуск шагов products+geography, сразу выбор количества
  ────────────────────────────────────────
  #: 61
  Сценарий: Нажать «Начать заново»
  Ожидание: FSM с шага products (ввод товаров)

  6.4 Загрузка файла (KeywordUploadFSM)

  #: 62
  Сценарий: Загрузить .txt файл (валидный, <= 500 фраз, <= 1MB, UTF-8)
  Ожидание: Прогресс «Обогащаю... Группирую...», результат «N кластеров, M фраз»
  ────────────────────────────────────────
  #: 63
  Сценарий: Загрузить файл не .txt (напр. .docx)
  Ожидание: «Нужен файл .txt (UTF-8)»
  ────────────────────────────────────────
  #: 64
  Сценарий: Загрузить .txt > 1MB
  Ожидание: «Файл слишком большой (макс. 1 МБ)»
  ────────────────────────────────────────
  #: 65
  Сценарий: Загрузить .txt > 500 фраз
  Ожидание: «Максимум 500 фраз. В файле: N»
  ────────────────────────────────────────
  #: 66
  Сценарий: Загрузить пустой .txt
  Ожидание: «Файл пуст или не содержит фраз»
  ────────────────────────────────────────
  #: 67
  Сценарий: Ввести текст вместо файла в FSM file_upload
  Ожидание: «Отправьте текстовый файл .txt»

  6.5 Просмотр кластеров

  #: 68
  Сценарий: Нажать «Кластеры»
  Ожидание: Список кластеров (пагинация, 8 на страницу)
  ────────────────────────────────────────
  #: 69
  Сценарий: Пагинация кластеров (>8 кластеров)
  Ожидание: Кнопки < 1/N > переключают страницы
  ────────────────────────────────────────
  #: 70
  Сценарий: Нажать на кластер
  Ожидание: Детали кластера: main_phrase, тип, кол-во фраз, список фраз текстом

  6.6 CSV экспорт

  #: 71
  Сценарий: Нажать «Скачать CSV»
  Ожидание: Документ .csv отправлен в чат, содержит все кластеры/фразы
  ────────────────────────────────────────
  #: 72
  Сценарий: CSV: спецсимволы в фразах (=, +, -, @)
  Ожидание: CSV-injection neutralized (префикс ' перед опасными символами)

  6.7 Удаление кластеров

  #: 73
  Сценарий: Нажать «Удалить кластер» (two-step)
  Ожидание: Список кластеров с [X] кнопками
  ────────────────────────────────────────
  #: 74
  Сценарий: Нажать [X] у конкретного кластера
  Ожидание: Кластер удалён, список обновлён
  ────────────────────────────────────────
  #: 75
  Сценарий: Удалить последний кластер через [X]
  Ожидание: Экран «Фразы не добавлены» (empty state)
  ────────────────────────────────────────
  #: 76
  Сценарий: Нажать «Удалить все»
  Ожидание: Экран подтверждения с DANGER-кнопкой
  ────────────────────────────────────────
  #: 77
  Сценарий: Подтвердить «Удалить все»
  Ожидание: Все кластеры удалены, экран «Фразы не добавлены»

  7. Описание (description.py)

  7.1 Экран описания

  #: 78
  Сценарий: Нажать «Описание» (нет описания)
  Ожидание: «Описание не заполнено» + кнопки «Сгенерировать AI» (SUCCESS) / «Ввести вручную» / «Назад»
    БЕЗ кнопки «Удалить»
  ────────────────────────────────────────
  #: 79
  Сценарий: Нажать «Описание» (есть описание)
  Ожидание: Текущее описание + кнопки «Сгенерировать AI» / «Ввести вручную» / «Удалить описание» (DANGER) / «Назад»

  7.2 AI-генерация (DescriptionGenerateFSM)

  #: 80
  Сценарий: Нажать «Сгенерировать AI» -> подтвердить (20 токенов, баланс OK)
  Ожидание: Токены списаны, описание сгенерировано, экран «Сохранить / Перегенерировать / Отмена»
  ────────────────────────────────────────
  #: 81
  Сценарий: E01: генерация описания (баланс < 20)
  Ожидание: «Недостаточно токенов. Нужно 20, у вас Y. [Пополнить]»
  ────────────────────────────────────────
  #: 82
  Сценарий: Отмена на экране подтверждения стоимости
  Ожидание: FSM сброшена, возврат к карточке
  ────────────────────────────────────────
  #: 83
  Сценарий: Review: нажать «Сохранить»
  Ожидание: Описание сохранено в категории, показан экран описания
  ────────────────────────────────────────
  #: 84
  Сценарий: Review: нажать «Перегенерировать» (1-я попытка, бесплатно)
  Ожидание: Новое описание, счётчик regen_count = 1
  ────────────────────────────────────────
  #: 85
  Сценарий: Review: нажать «Перегенерировать» (2-я попытка, бесплатно)
  Ожидание: Новое описание, счётчик regen_count = 2
  ────────────────────────────────────────
  #: 86
  Сценарий: Review: нажать «Перегенерировать» (3-я попытка, платная)
  Ожидание: «Бесплатные перегенерации исчерпаны. Стоимость: 20 токенов.» или кнопка disabled
  ────────────────────────────────────────
  #: 87
  Сценарий: Review: нажать «Отмена»
  Ожидание: FSM сброшена, возврат к карточке (описание НЕ сохранено)

  7.3 Ручной ввод

  #: 88
  Сценарий: Нажать «Ввести вручную» -> ввести текст (10-2000 символов)
  Ожидание: Описание сохранено, показан экран описания
  ────────────────────────────────────────
  #: 89
  Сценарий: Ручной ввод: < 10 символов
  Ожидание: Ошибка «минимум 10 символов», повтор
  ────────────────────────────────────────
  #: 90
  Сценарий: Ручной ввод: > 2000 символов
  Ожидание: Ошибка «максимум 2000 символов», повтор

  7.4 Удаление описания

  #: 91
  Сценарий: Нажать «Удалить описание»
  Ожидание: Описание очищено, показан экран «Описание не заполнено» (без кнопки «Удалить»)

  8. Цены (prices.py)

  8.1 Экран цен

  #: 92
  Сценарий: Нажать «Цены» (нет прайса)
  Ожидание: «Прайс-лист не загружен» + кнопки «Ввести текстом» / «Загрузить Excel» / «Назад»
    БЕЗ кнопки «Удалить»
  ────────────────────────────────────────
  #: 93
  Сценарий: Нажать «Цены» (есть прайс)
  Ожидание: Превью первых 10 позиций + «Обновить текстом» / «Обновить Excel» / «Удалить» (DANGER) / «Назад»

  8.2 Текстовый ввод (PriceInputFSM)

  #: 94
  Сценарий: Нажать «Ввести текстом» -> ввести «Товар1 - 100\nТовар2 - 200»
  Ожидание: Прайс сохранён (2 позиции), показан экран цен
  ────────────────────────────────────────
  #: 95
  Сценарий: Текст: только пустые строки
  Ожидание: Ошибка «Нет позиций» или «минимум 1 строка»
  ────────────────────────────────────────
  #: 96
  Сценарий: Текст: формат «Name — Price» с длинным тире
  Ожидание: Парсится корректно (поддержка -, --, —)

  8.3 Excel загрузка (PriceInputFSM)

  #: 97
  Сценарий: Загрузить .xlsx (валидный, <= 1000 строк, <= 5MB)
  Ожидание: Прайс сохранён, показан экран цен
  ────────────────────────────────────────
  #: 98
  Сценарий: Загрузить файл не .xlsx (напр. .csv)
  Ожидание: «Нужен файл .xlsx (Excel)»
  ────────────────────────────────────────
  #: 99
  Сценарий: E09: Excel > 5MB
  Ожидание: «Файл слишком большой (макс. 5 МБ)»
  ────────────────────────────────────────
  #: 100
  Сценарий: E09: Excel > 1000 строк
  Ожидание: «Максимум 1000 позиций. В файле: N»
  ────────────────────────────────────────
  #: 101
  Сценарий: Excel: пустой файл (0 строк с данными)
  Ожидание: «Файл пуст или не содержит данных»
  ────────────────────────────────────────
  #: 102
  Сценарий: Excel: ввести текст вместо файла в FSM file_upload
  Ожидание: «Отправьте файл .xlsx (Excel)»

  8.4 Удаление прайса

  #: 103
  Сценарий: Нажать «Удалить прайс»
  Ожидание: Прайс очищен, показан экран «Прайс-лист не загружен» (без «Удалить»)

  9. Настройки контента (content_settings.py)

  9.1 Главный экран

  #: 104
  Сценарий: Нажать «Настройки контента»
  Ожидание: 4 кнопки: «Длина текста», «Стиль текста», «Кол-во изображений», «Стиль изображений» + «Назад»

  9.2 Длина текста (ContentSettingsFSM)

  #: 105
  Сценарий: Нажать «Длина текста» -> ввести min (напр. 1000)
  Ожидание: «Введите максимальное кол-во слов (> 1000, до 10000)»
  ────────────────────────────────────────
  #: 106
  Сценарий: Ввести max (напр. 3000)
  Ожидание: Сохранено «1000-3000 слов», возврат к настройкам
  ────────────────────────────────────────
  #: 107
  Сценарий: Min < 500
  Ожидание: Ошибка «минимум 500 слов», повтор
  ────────────────────────────────────────
  #: 108
  Сценарий: Min > 10000
  Ожидание: Ошибка «максимум 10000 слов», повтор
  ────────────────────────────────────────
  #: 109
  Сценарий: Min = нечисловой ввод (напр. «abc»)
  Ожидание: Ошибка «введите число», повтор
  ────────────────────────────────────────
  #: 110
  Сценарий: Max <= min (напр. min=2000, max=1500)
  Ожидание: Ошибка «должно быть больше 2000», повтор
  ────────────────────────────────────────
  #: 111
  Сценарий: Max > 10000
  Ожидание: Ошибка «максимум 10000», повтор
  ────────────────────────────────────────
  #: 112
  Сценарий: Сессия устарела (FSM data потеряна)
  Ожидание: «Сессия устарела. Начните настройку заново.»

  9.3 Стиль текста (callbacks, без FSM)

  #: 113
  Сценарий: Нажать «Стиль текста»
  Ожидание: Grid 10 стилей, выбранные отмечены галочкой
  ────────────────────────────────────────
  #: 114
  Сценарий: Нажать на невыбранный стиль
  Ожидание: Стиль добавлен в selected, галочка появилась
  ────────────────────────────────────────
  #: 115
  Сценарий: Нажать на уже выбранный стиль
  Ожидание: Стиль убран из selected, галочка исчезла
  ────────────────────────────────────────
  #: 116
  Сценарий: Нажать «Сохранить стили»
  Ожидание: Стили сохранены в text_settings, возврат к настройкам
  ────────────────────────────────────────
  #: 117
  Сценарий: 10 стилей: Рекламный, Мотивационный, Дружелюбный, Разговорный,
    Профессиональный, Креативный, Информативный, С юмором, Мужской, Женский
  Ожидание: Все 10 присутствуют, индексы 0-9 в callback_data

  9.4 Количество изображений (callbacks)

  #: 118
  Сценарий: Нажать «Кол-во изображений»
  Ожидание: Кнопки 0-10, текущее значение отмечено
  ────────────────────────────────────────
  #: 119
  Сценарий: Выбрать количество (напр. 4)
  Ожидание: Сохранено в image_settings.count = 4, возврат к настройкам
  ────────────────────────────────────────
  #: 120
  Сценарий: Выбрать 0 изображений
  Ожидание: Сохранено count = 0, статьи будут без изображений

  9.5 Стиль изображений (callbacks)

  #: 121
  Сценарий: Нажать «Стиль изображений»
  Ожидание: 6 стилей: Фотореализм, Аниме, Масло, Акварель, Мультяшный, Минимализм
  ────────────────────────────────────────
  #: 122
  Сценарий: Выбрать стиль (напр. Акварель)
  Ожидание: Сохранено в image_settings.style = «Акварель», возврат к настройкам

  10. Edge Cases (F3, критические)

  #: 123
  Сценарий: Callback tampering: подменить category_id в callback (keywords/description/prices/settings)
  Ожидание: «Категория не найдена» (ownership check через project.user_id)
  ────────────────────────────────────────
  #: 124
  Сценарий: FSM conflict: находиться в KeywordGenerationFSM, нажать «Описание»
  Ожидание: Текущая FSM сбрасывается с уведомлением, новая FSM стартует (ensure_no_active_fsm)
  ────────────────────────────────────────
  #: 125
  Сценарий: E03: DataForSEO недоступен при генерации ключевых фраз
  Ожидание: Fallback -- AI генерация, предупреждение «Данные без реальных объёмов поиска»
  ────────────────────────────────────────
  #: 126
  Сценарий: E36: legacy keywords (без cluster_name) в категории
  Ожидание: Fallback на фразовую ротацию (плоский список)
  ────────────────────────────────────────
  #: 127
  Сценарий: Генерация ключевых фраз: pipeline error посередине (после charge)
  Ожидание: Refund токенов, сообщение об ошибке
  ────────────────────────────────────────
  #: 128
  Сценарий: Описание: AI error при генерации
  Ожидание: Refund 20 токенов, сообщение об ошибке
  ────────────────────────────────────────
  #: 129
  Сценарий: Описание: AI error при перегенерации (бесплатной)
  Ожидание: Сообщение об ошибке, предыдущий текст остаётся в review
  ────────────────────────────────────────
  #: 130
  Сценарий: Excel: openpyxl не может открыть файл (corrupt .xlsx)
  Ожидание: «Не удалось прочитать файл. Проверьте формат.»
  ────────────────────────────────────────
  #: 131
  Сценарий: CSV export: фразы с символами = + - @ (formula injection)
  Ожидание: Символы нейтрализованы (prefix '), Excel не исполняет формулы
  ────────────────────────────────────────
  #: 132
  Сценарий: callback_data 64-byte limit: все callback_data в F3
  Ожидание: Все < 64 байт (index-based: settings:999:ts:9 = 18 байт, безопасно)
  ────────────────────────────────────────
  #: 133
  Сценарий: Удалить все кластеры, потом нажать «Кластеры»
  Ожидание: Экран «Фразы не добавлены» (не ошибка пустого списка)
  ────────────────────────────────────────
  #: 134
  Сценарий: GOD_MODE (admin): генерация ключевых фраз
  Ожидание: Токены НЕ списываются, но стоимость показывается
  ────────────────────────────────────────
  #: 135
  Сценарий: GOD_MODE (admin): генерация описания
  Ожидание: Токены НЕ списываются, описание генерируется
