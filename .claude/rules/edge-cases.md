---
paths:
  - "routers/**/*.py"
  - "services/**/*.py"
  - "api/**/*.py"
---

# Edge Cases (docs/EDGE_CASES.md)

При реализации ЛЮБОГО обработчика проверяй применимые edge cases:

## Критические (проверять всегда)
- E01: Баланс 0 → "Недостаточно токенов. Нужно ~{N}, у вас 0. [Пополнить]"
- E06: Двойное QStash-задание → Redis NX lock, 200 "Already processing"
- E07: Двойное нажатие "Опубликовать" → FSM preview→publishing одноразовый
- E12: OpenRouter 429 → fallback по MODEL_CHAINS, при исчерпании → возврат токенов
- E13: 2 устройства → один FSM-стейт на user_id в Redis
- E16: 0 фраз → блокировать публикацию, "[Подобрать фразы]"
- E25: Rate limit → токены НЕ списываются, FSM остаётся

## Платформо-специфичные
- E02: WordPress недоступен → возврат токенов, status=error
- E05: Telegraph down → публиковать без превью, 500 символов в чат
- E08: VK токен отозван → status=error, "[Переподключить VK]"
- E15: Firecrawl недоступен → подключение проходит, QStash retry 3x

## Автопубликация
- E17: 0 фраз при автопубликации → пропустить, уведомить, расписание НЕ отключать
- E22: Все фразы на cooldown → LRU, уведомить
- E23: <5 фраз → в отчёт "Добавьте ещё фраз"

## Удаление
- E11: Удаление проекта → отменить ВСЕ QStash-расписания ПЕРЕД CASCADE
- E24: Удаление категории → отменить QStash категории ПЕРЕД CASCADE

## Платежи
- E10: Перегенерация 3+ при балансе 0 → "[Пополнить] или [Опубликовать текущий]"
- E18: Превью >24ч → "Превью устарело. Токены возвращены."
- E19: Stars недостаточно → подписка приостановлена
