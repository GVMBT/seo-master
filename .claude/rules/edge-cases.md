---
paths:
  - "routers/**/*.py"
  - "services/**/*.py"
  - "api/**/*.py"
---

# Edge Cases (docs/EDGE_CASES.md)

При реализации ЛЮБОГО обработчика проверяй применимые edge cases:

## Критические (проверять всегда)
- E01: Баланс 0 → "Недостаточно токенов. Нужно ~{N}, у вас 0. [Пополнить]"
- E06: Двойное QStash-задание → Redis NX lock, 200 "Already processing"
- E07: Двойное нажатие "Опубликовать" → FSM preview→publishing одноразовый
- E12: OpenRouter 429 → fallback по MODEL_CHAINS, при исчерпании → возврат токенов
- E13: 2 устройства → один FSM-стейт на user_id в Redis
- E16: 0 фраз → блокировать публикацию, "[Подобрать фразы]"
- E25: Rate limit → токены НЕ списываются, FSM остаётся

## Внешние API
- E02: WordPress недоступен → возврат токенов, status=error
- E03: DataForSEO вернул 0 → показать фразы БЕЗ объёмов, пометить "нет данных"
- E04: Serper квота исчерпана → генерировать без Serper-данных, предупредить пользователя
- E05: Telegraph down → публиковать без превью, 500 символов в чат
- E08: VK токен отозван → status=error, "[Переподключить VK]"
- E15: Firecrawl недоступен → подключение проходит, QStash retry 3x

## Подключения
- E20: Pinterest OAuth не завершён (30 мин) → FSM автосброс, "Подключение отменено"
- E21: Pinterest OAuth ошибка → сообщение + [Попробовать снова] [К подключениям]

## Ввод данных
- E09: Excel 10000+ строк → лимит 1000 строк / 5 MB, "Максимум 1000 товаров"
- E14: Реферер удалил аккаунт → referrer_id → NULL (ON DELETE SET NULL)

## Автопубликация
- E17: 0 фраз при автопубликации → пропустить, уведомить, расписание НЕ отключать
- E22: Все фразы на cooldown → LRU fallback, уведомить
- E23: <3 кластеров → в отчёт "Добавьте ещё фраз"

## Удаление
- E11: Удаление проекта → отменить ВСЕ QStash-расписания ПЕРЕД CASCADE
- E24: Удаление категории → отменить QStash категории ПЕРЕД CASCADE

## Платежи
- E10: Перегенерация 3+ при балансе 0 → "[Пополнить] или [Опубликовать текущий]"
- E18: Превью >24ч → "Превью устарело. Токены возвращены."
- E19: Stars недостаточно → подписка приостановлена
