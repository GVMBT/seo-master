# SEO Master Bot v2 — Edge Cases и обработка ошибок

> Связанные документы: [PRD.md](PRD.md) (продуктовые требования), [ARCHITECTURE.md](ARCHITECTURE.md) (техническая архитектура), [API_CONTRACTS.md](API_CONTRACTS.md) (QStash, Stars, rate limits), [FSM_SPEC.md](FSM_SPEC.md) (FSM-состояния), [USER_FLOWS_AND_UI_MAP.md](USER_FLOWS_AND_UI_MAP.md) (экраны и навигация)

## Таблица edge cases

| # | Сценарий | Ожидаемое поведение |
|---|---------|---------------------|
| E01 | Баланс 0, попытка генерации | "Недостаточно токенов. Нужно ~320, у вас 0. [Пополнить]" |
| E02 | WordPress недоступен при публикации | Возврат токенов, статус error, "[Проверить подключение]" |
| E03 | DataForSEO вернул 0 результатов | Показать фразы БЕЗ объёмов/сложности, пометить "нет данных" |
| E04 | Serper квота исчерпана | Генерировать статью без Serper-данных, предупредить: "Статья без актуальных данных Google" |
| E05 | Telegraph API down | Публиковать без превью, показать сокращённый текст в чате (первые 500 символов) |
| E06 | Два QStash-задания одновременно для одного user | Redis-блокировка (API_CONTRACTS.md §1.4), второе задание → 200 "Already processing" |
| E07 | Двойное нажатие "Опубликовать" | FSM-гарантия: состояние `preview` → `publishing` (одноразовый переход), повторный клик → "Уже публикуется" |
| E08 | VK-токен отозван | При ошибке API → пометить connection status=error, уведомить "[Переподключить VK]" |
| E09 | Excel с 10000+ товаров | Лимит: 1000 строк, 5 MB. При превышении: "Максимум 1000 товаров. Сократите файл" |
| E10 | Перегенерация 3+ (платная), баланс 0 | "Перегенерация стоит ~320 токенов, у вас 0. [Пополнить] или [Опубликовать текущий]" |
| E11 | Удаление проекта с активными расписаниями | CASCADE удаление, отмена всех QStash-расписаний через qstash_schedule_ids |
| E12 | OpenRouter 429 (rate limit) | Автопереключение на fallback модель по цепочке MODEL_CHAINS (см. API_CONTRACTS §3.1). При исчерпании цепочки → возврат токенов, уведомление |
| E13 | Пользователь на 2 устройствах одновременно | FSM в Redis — один стейт на user_id. Второе устройство видит "Вы уже в процессе {действие}" |
| E14 | Реферер удалил аккаунт | Бонус теряется (referrer_id → NULL через ON DELETE SET NULL) |
| E15 | Firecrawl недоступен при подключении сайта | Подключение проходит, краулинг/брендинг → фоновая задача через QStash (retry 3 раза) |
| E16 | 0 ключевых фраз в категории, нажата "Опубликовать" | "В категории нет ключевых фраз. Добавьте хотя бы одну фразу для генерации контента. [Подобрать фразы]" — публикация блокируется |
| E17 | 0 ключевых фраз при автопубликации (QStash) | Пропустить публикацию, уведомить: "Автопубликация пропущена: нет ключевых фраз в категории «{name}». [Подобрать фразы]". Расписание НЕ отключать |
| E18 | Превью истекло (>24ч), пользователь нажал "Опубликовать" | "Превью устарело. Сгенерируйте статью заново." Токены уже возвращены cleanup-задачей. Кнопки: [Сгенерировать заново] [К категории] |
| E19 | Подписка Stars: недостаточно Stars для продления | Подписка приостанавливается. Бот уведомляет: "Подписка Pro приостановлена — недостаточно Stars для продления. Расписания продолжают работать на текущем балансе." Кнопки: [Пополнить Stars] [Управление подпиской] |
| E20 | Pinterest OAuth: пользователь не завершил авторизацию (30 мин) | FSM автосброс. "Подключение Pinterest отменено. Попробуйте снова." |
| E21 | Pinterest OAuth: ошибка авторизации | "Не удалось подключить Pinterest: {error}." Кнопки: [Попробовать снова] [К подключениям] |
| E22 | Пул ключевых фраз: все фразы на cooldown (7 дней) | Взять LRU (самую давнюю). Уведомить: "Все фразы использованы за последние 7 дней. Используем фразу «{keyword}» повторно. [Добавить ещё фраз]" |
| E23 | Пул ключевых фраз: <5 фраз в категории | При автопубликации: добавить в отчёт "Добавьте ещё ключевых фраз для разнообразия контента. [Подобрать фразы]" |
| E24 | Удаление категории с активными QStash-расписаниями | Отменить все QStash-расписания категории (по qstash_schedule_ids) ПЕРЕД CASCADE-удалением записей в platform_schedules |
| E25 | Rate limit: превышен лимит генерации контента | Токены НЕ списываются. "Превышен лимит генераций ({limit}/час). Следующая попытка через {minutes} мин." FSM остаётся в текущем состоянии. Кнопки: [Отмена] |

## Уведомления о пропущенных автопубликациях

| Причина пропуска | Уведомление | Действие |
|-----------------|-------------|----------|
| Недостаточно токенов | "Автопубликация пропущена: недостаточно токенов (нужно ~320, баланс: {N}). Расписание приостановлено." | Расписание → `enabled: false`, кнопки: `[Пополнить баланс]` `[К расписанию]` |
| Платформа недоступна (3 retry) | "Автопубликация не удалась: {platform} не отвечает. Проверьте подключение." | Расписание → `status: error`, кнопки: `[Проверить подключение]` `[К расписанию]` |
| Контент не прошёл валидацию | "Автопубликация пропущена: сгенерированный контент не прошёл проверку качества." | Токены возвращены, кнопки: `[Опубликовать вручную]` `[К категории]` |
| AI-сервис недоступен | "Автопубликация отложена: AI-сервис временно недоступен. Повторим через 1 час." | Не отключать расписание, повторить при следующем триггере |

## Валидация контента при автопубликации (без превью)

Перед публикацией автоматически проверяется:
- Длина текста ≥ 500 символов (защита от обрезанных ответов AI)
- Наличие H1 (для статей на WordPress)
- Отсутствие placeholder-текста (`[INSERT`, `Lorem ipsum`, `TODO`)
- Наличие хотя бы 1 абзаца связного текста

При провале валидации → возврат токенов, уведомление пользователю.

## Дополнительные edge cases (v2.5)

| # | Сценарий | Ожидаемое поведение |
|---|---------|---------------------|
| E26 | Конфликт FSM: пользователь начинает новую FSM, находясь в другой | Автосброс текущей FSM. "Предыдущий процесс ({old_name}) прерван." Для SocialPostPublish — токены за сгенерированный контент НЕ возвращаются (дешёвые ~40 токенов). Для ArticlePublish — превью остаётся в БД, cleanup вернёт через 24ч |
| E27 | SocialPostPublish: таймаут FSM (30 мин) при сгенерированном контенте в Redis | Контент теряется, токены НЕ возвращаются. Допустимо для ~40 токенов. Уведомление: "Сессия истекла. Сгенерируйте пост заново." |
| E28 | Множественные WP-подключения: публикация через Quick Publish | При >1 WP-подключении в проекте → добавить промежуточный шаг выбора подключения. Callback: `quick:cat:{cat_id}:wp:{conn_id}` |
| E29 | Health endpoint: DDoS / timing attack | Без `HEALTH_CHECK_TOKEN` → возвращать только `{"status": "ok"}` без latency, версий БД, количества подключений |
| E30 | Pinterest OAuth: CSRF-атака через подмену state | `state` = HMAC-SHA256(user_id + nonce, ENCRYPTION_KEY). При несовпадении HMAC → 403, "Ошибка авторизации. Попробуйте заново." |
