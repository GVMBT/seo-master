# SEO Master Bot v2 — Edge Cases и обработка ошибок

> Связанные документы: [PRD.md](PRD.md) (продуктовые требования), [ARCHITECTURE.md](ARCHITECTURE.md) (техническая архитектура), [API_CONTRACTS.md](API_CONTRACTS.md) (QStash, Stars, rate limits), [FSM_SPEC.md](FSM_SPEC.md) (FSM-состояния), [UX_PIPELINE.md](UX_PIPELINE.md) + [UX_TOOLBOX.md](UX_TOOLBOX.md) (UX-спецификации)

## Таблица edge cases

| # | Сценарий | Ожидаемое поведение |
|---|---------|---------------------|
| E01 | Баланс 0, попытка генерации | "Недостаточно токенов. Нужно ~320, у вас 0. [Пополнить]" |
| E02 | WordPress недоступен при публикации | Возврат токенов, статус error, "[Проверить подключение]" |
| E03 | DataForSEO недоступен / 0 результатов | Fallback: AI генерирует фразы "из головы" БЕЗ кластеризации (legacy-режим). Предупредить: "Данные без реальных объёмов поиска". При 0 результатах enrichment — показать фразы БЕЗ объёмов/сложности, пометить "нет данных" |
| E04 | Serper квота исчерпана | Генерировать статью без Serper-данных, предупредить: "Статья без актуальных данных Google" |
| E05 | Telegraph API down | Публиковать без превью, показать сокращённый текст в чате (первые 500 символов) |
| E06 | Два QStash-задания одновременно для одного user | Redis-блокировка (API_CONTRACTS.md §1.4), второе задание → 200 "Already processing" |
| E07 | Двойное нажатие "Опубликовать" | FSM-гарантия: состояние `preview` → `publishing` (одноразовый переход), повторный клик → "Уже публикуется" |
| E08 | VK-токен отозван | При ошибке API → пометить connection status=error, уведомить "[Переподключить VK]" |
| E09 | Excel с 10000+ товаров | Лимит: 1000 строк, 5 MB. При превышении: "Максимум 1000 товаров. Сократите файл" |
| E10 | Перегенерация 3+ (платная), баланс 0 | "Перегенерация стоит ~320 токенов, у вас 0. [Пополнить] или [Опубликовать текущий]" |
| E11 | Удаление проекта с активными расписаниями | CASCADE удаление, отмена всех QStash-расписаний через qstash_schedule_ids |
| E12 | OpenRouter 429 (rate limit) | Автопереключение на fallback модель по цепочке MODEL_CHAINS (см. API_CONTRACTS §3.1). При исчерпании цепочки → возврат токенов, уведомление |
| E13 | Пользователь на 2 устройствах одновременно | FSM в Redis — один стейт на user_id. Второе устройство видит "Вы уже в процессе {действие}" |
| E14 | Реферер удалил аккаунт | Бонус теряется (referrer_id → NULL через ON DELETE SET NULL) |
| E15 | Firecrawl недоступен при подключении сайта | Подключение проходит, краулинг/брендинг → фоновая задача через QStash (retry 3 раза) |
| E16 | 0 ключевых фраз в категории, нажата "Опубликовать" | "В категории нет ключевых фраз. Добавьте хотя бы одну фразу для генерации контента. [Подобрать фразы]" — публикация блокируется |
| E17 | 0 ключевых фраз при автопубликации (QStash) | Пропустить публикацию, уведомить: "Автопубликация пропущена: нет ключевых фраз в категории «{name}». [Подобрать фразы]". Расписание НЕ отключать |
| E18 | Превью истекло (>24ч), пользователь нажал "Опубликовать" | "Превью устарело. Сгенерируйте статью заново." Токены уже возвращены cleanup-задачей. Кнопки: [Сгенерировать заново] [К категории] |
| E19 | Подписка Stars: недостаточно Stars для продления | Подписка приостанавливается. Бот уведомляет: "Подписка Pro приостановлена — недостаточно Stars для продления. Расписания продолжают работать на текущем балансе." Кнопки: [Пополнить Stars] [Управление подпиской] |
| E20 | Pinterest OAuth: пользователь не завершил авторизацию (30 мин) | FSM автосброс. "Подключение Pinterest отменено. Попробуйте снова." |
| E21 | Pinterest OAuth: ошибка авторизации | "Не удалось подключить Pinterest: {error}." Кнопки: [Попробовать снова] [К подключениям] |
| E22 | Пул кластеров: все кластеры на cooldown (7 дней) | Взять LRU (самый давний кластер). Уведомить: "Все кластеры использованы за последние 7 дней. Используем кластер «{main_phrase}» повторно. [Добавить ещё фраз]" |
| E23 | Пул кластеров: <3 кластеров с cluster_type="article" в категории | При автопубликации статей: добавить в отчёт "Добавьте ещё ключевых фраз для разнообразия контента. [Подобрать фразы]". Минимальный пул — 3 кластера с cluster_type="article" (см. API_CONTRACTS §6 шаг 2) |
| E24 | Удаление категории с активными QStash-расписаниями | Отменить все QStash-расписания категории (по qstash_schedule_ids) ПЕРЕД CASCADE-удалением записей в platform_schedules |
| E25 | Rate limit: превышен лимит генерации контента | Токены НЕ списываются. "Превышен лимит генераций ({limit}/час). Следующая попытка через {minutes} мин." FSM остаётся в текущем состоянии. Кнопки: [Отмена] |

## Уведомления о пропущенных автопубликациях

| Причина пропуска | Уведомление | Действие |
|-----------------|-------------|----------|
| Недостаточно токенов | "Автопубликация пропущена: недостаточно токенов (нужно ~320, баланс: {N}). Расписание приостановлено." | Расписание → `enabled: false`, кнопки: `[Пополнить баланс]` `[К расписанию]` |
| Платформа недоступна (3 retry) | "Автопубликация не удалась: {platform} не отвечает. Проверьте подключение." | Расписание → `status: error`, кнопки: `[Проверить подключение]` `[К расписанию]` |
| Контент не прошёл валидацию | "Автопубликация пропущена: сгенерированный контент не прошёл проверку качества." | Токены возвращены, кнопки: `[Опубликовать вручную]` `[К категории]` |
| AI-сервис недоступен | "Автопубликация отложена: AI-сервис временно недоступен. Повторим через 1 час." | Не отключать расписание, повторить при следующем триггере |

## Валидация контента при автопубликации (без превью)

Перед публикацией автоматически проверяется:
- Длина текста ≥ 500 символов (защита от обрезанных ответов AI)
- Наличие H1 (для статей на WordPress)
- Отсутствие placeholder-текста (`[INSERT`, `Lorem ipsum`, `TODO`)
- Наличие хотя бы 1 абзаца связного текста

При провале валидации → возврат токенов, уведомление пользователю.

## Дополнительные edge cases (v2.5)

| # | Сценарий | Ожидаемое поведение |
|---|---------|---------------------|
| E26 | Конфликт FSM: пользователь начинает новую FSM, находясь в другой | Автосброс текущей FSM. "Предыдущий процесс ({old_name}) прерван." Для SocialPostPublish — токены за сгенерированный контент НЕ возвращаются (дешёвые ~40 токенов). Для ArticlePublish — превью остаётся в БД, cleanup вернёт через 24ч |
| E27 | SocialPostPublish: таймаут FSM (30 мин) при сгенерированном контенте в Redis | Контент теряется, токены НЕ возвращаются. Допустимо для ~40 токенов. Уведомление: "Сессия истекла. Сгенерируйте пост заново." |
| E28 | Множественные WP-подключения: публикация через Pipeline | При >1 WP-подключении в проекте → Pipeline шаг 2 показывает список подключённых сайтов. Callback: `pipeline:article:wp:{conn_id}` |
| E29 | Health endpoint: DDoS / timing attack | Без `HEALTH_CHECK_TOKEN` → возвращать только `{"status": "ok"}` без latency, версий БД, количества подключений |
| E30 | Pinterest OAuth: CSRF-атака через подмену state | `state` = HMAC-SHA256(user_id + nonce, ENCRYPTION_KEY). При несовпадении HMAC → 403, "Ошибка авторизации. Попробуйте заново." |
| E31 | Firecrawl /scrape timeout при генерации статьи | Graceful degradation: статья генерируется БЕЗ competitor_analysis и competitor_gaps. Длина — из text_settings (не динамическая). Предупредить: "Анализ конкурентов недоступен, статья сгенерирована без конкурентных данных." |
| E32 | images_meta count ≠ image_settings.count | Reconciliation (API_CONTRACTS §Stage 5): если images < meta — лишние meta отбрасываются, unreplaced {{IMAGE_N}} удаляются из HTML. Если images > meta — generic alt/filename из title. НЕ является ошибкой — reconciliation обрабатывает автоматически |
| E33 | WebP-конвертация: PIL не может обработать изображение | Fallback на PNG: публиковать в исходном формате. Warning в лог. Filename без .webp → .png |
| E34 | Параллельный pipeline: текст OK, все изображения failed | Публиковать статью БЕЗ изображений. Возврат 30×N токенов за изображения. Уведомить: "Статья опубликована без изображений (генерация не удалась). Возвращено {N} токенов." Кнопки: [Добавить изображения] [К категории] |
| E35 | Параллельный pipeline: изображения OK, текст failed | НЕ публиковать. Возврат ВСЕХ токенов (текст + изображения). Уведомить: "Генерация статьи не удалась. Токены возвращены." Кнопки: [Попробовать снова] [К категории] |
| E36 | Legacy keywords (без cluster_name) при cluster rotation | Fallback на фразовую ротацию: keywords как плоский список, volume DESC, difficulty ASC, cooldown 7 дней по отдельным фразам. Работает для старых категорий до перекластеризации |
| E37 | YooKassa автосписание: payment.canceled при автопродлении | Подписка остаётся active до expires_at (текущий оплаченный период). Уведомить: "Автопродление не удалось. Подписка действует до {date}. [Обновить способ оплаты] [Оплатить Stars]". Расписания НЕ отключать до expires_at |
| E38 | ~~Генерация N отзывов, баланс < N × 10~~ | ~~ReviewGenerationFSM~~ Deferred to v3 (F17 отзывы убраны из v2) |
| E39 | YooKassa webhook: дубликат уведомления | Идемпотентность по `object.id` в Redis (NX lock, 24ч). Повторный webhook → 200 OK без действий |
| E40 | Статья: категория без article-кластеров (только product_page) | Ротация для статей возвращает 0 кандидатов. Уведомить: "В категории нет кластеров для статей. Добавьте информационные фразы. [Подобрать фразы]". Социальные посты при этом работают — используют любой cluster_type (см. §6.1) |
| E41 | Подключение WP-сайта, уже привязанного к другому проекту того же пользователя | UNIQUE(project_id, platform_type, identifier) допускает это. By design: один сайт может быть в разных проектах (разные категории контента). НО: предупредить "Этот сайт уже подключён к проекту «{name}». Публикации в оба проекта будут идти на один сайт." Пользователь подтверждает или отменяет |
| E42 | Удаление проекта/категории при активном article_preview | article_previews каскадно удаляется (ON DELETE CASCADE на project_id, category_id). Токены (tokens_charged) теряются — cleanup cron не найдёт строку. Решение: при удалении проекта/категории — сначала найти активные превью (status=draft), возвратить tokens_charged через refund_balance, затем удалять. Аналогично E11/E24 (QStash перед CASCADE) |
| E43 | Multi-step: outline generation failed (DeepSeek timeout) | Fallback: пропустить outline, генерировать one-shot через Claude (article_v7.yaml без outline). Стоимость та же, качество чуть ниже. Логировать "outline_skipped" |
| E44 | Multi-step: critique triggered but rewrite also scores < 80 | Принять rewrite как есть (не зацикливать). Максимум 1 critique → 1 rewrite. Если score < 40 после rewrite → block + refund (как обычно). Warning в лог: "critique_did_not_improve" |
| E45 | ContentQualityScorer: razdel/pymorphy3 crash | Graceful degradation: score naturalness/readability = 0, остальные метрики работают. Warning "nlp_scorer_fallback". Publish allowed (score будет ниже, но не блокируется из-за NLP-ошибки) |
| E46 | SimHash: content_hash collision (Hamming ≤ 3 с чужой статьёй) | Warning пользователю: "Статья похожа на ранее опубликованную. Рекомендуем переформулировать." Publish NOT blocked — только warning. Не сравнивать с другими user_id (только свои публикации) |
| E47 | Markdown → HTML: mistune parse error | Fallback: использовать raw Markdown как plain text в `<pre>` блоке. Log "markdown_parse_failed". Редкий случай — mistune устойчив к невалидному Markdown |
| E48 | Anti-hallucination: цена в тексте не совпадает с прайсом | Warning (не error): "Возможно выдуманная цена: {N} руб." Пользователь решает при превью. НЕ блокировать публикацию — может быть контекстная цена ("от 10 000 руб./мес" для услуги, не из прайса товаров) |

## Pipeline edge cases (UX_PIPELINE.md)

| # | Сценарий | Ожидаемое поведение |
|---|---------|---------------------|
| E49 | Pipeline прерван на mid-step (FSM timeout 30 мин) | Redis checkpoint (`pipeline:{user_id}:state`, TTL 24ч) жив — при возврате пользователя предложить "Продолжить" / "Начать заново" / "Отменить" (UX_PIPELINE.md §2.6, §10.3). После 24ч — checkpoint удалён, начать заново |
| E50 | Pipeline inline sub-flow fail (ConnectWP: сайт недоступен) | Вернуться в pipeline с сообщением об ошибке: "Не удалось подключить WP". Кнопки: [Повторить] [Только превью] [Другой сайт]. Pipeline state сохраняется |
| E51 | Pipeline + insufficient balance → пополнение → автовозврат | На шаге 5 (подтверждение): "Недостаточно токенов". Кнопка [Пополнить]. После пополнения (Stars/YooKassa) — webhook проверяет наличие `pipeline:{user_id}:state` → proactive message "Баланс пополнен! Продолжить?" |
| E52 | Pipeline кросс-постинг: адаптация failed | Оригинальный пост уже опубликован, токены за cross-post (~10) возвращаются. "Не удалось адаптировать для {platform}. Токены возвращены." Кнопки: [Повторить] [Пропустить] |
