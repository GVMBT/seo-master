# UI Strategy — SEO Master Bot v2

> **Версия:** 1.1
> **Дата:** 2026-02-16
> **Источники:** UI Text Audit (Opus 4.6), Code Audit (28 роутеров, 8 клавиатур), UX_PIPELINE v1.7
> **Цель:** Единая стратегия улучшения UX/UI бота — от P0-багов до стратегических изменений

---

## 0. Что работает хорошо (baseline)

Ниже — базовые вещи, которые не нужно менять. Стратегия строится поверх них.

### 0.1 Архитектура UI

| Аспект | Реализация |
|--------|-----------|
| **Dashboard 3 варианта** | New user / no projects / returning — адаптивный текст (`start.py:59-82`) |
| **guard_callback_message** | InaccessibleMessage-защита через `_helpers.py`, применяется во всех callback-хендлерах |
| **Readiness checklist** | 4 пункта, cost hints, «Всё OK — генерировать» CTA (`readiness.py`, `pipeline.py:151-178`) |
| **Keyword sub-flow** | Inline: auto/custom → geo → qty → generate → back to checklist. Полный цикл |
| **Notification toggles** | 3 типа, мгновенный flip + re-render клавиатуры (`settings.py:56-78`) |
| **Empty states** | project_list_kb при пустом списке → [Создать проект] + [Помощь] (`inline.py:66-70`) |
| **Pipeline checkpoint** | Redis TTL 24h, resume prompt на /start и кнопку «Написать статью» (`article.py:210-223`, `start.py:112-137`) |
| **Pagination** | Единый `paginate()` с PAGE_SIZE=8, сквозной для проектов/категорий/pipeline |
| **ButtonStyle** | PRIMARY/SUCCESS/DANGER семантика. 21 использование, 90% соответствует спеку |
| **callback_data** | Единый формат `entity:id:action` < 64 байт. 100% соответствие |
| **FSM guards** | Double-click protection (E07): preview→publishing одноразовый переход |
| **Auth helpers** | `_get_project_or_notify()`, `_get_category_or_notify()` проверяют ownership |

### 0.2 Тексты — что уже хорошо

| Аспект | Пример | Где |
|--------|--------|-----|
| **Pipeline headers** | `"Статья > Шаг 1: проект"`, `"Статья > WordPress"`, `"Статья > Подготовка данных"` | `article.py` |
| **Короткие промпты** | `"Для какого проекта?"`, `"На какой сайт?"`, `"Какая тема?"` | `article.py:191,294,356` |
| **Readiness иконки** | `✅ Ключевые фразы — заполнено` / `⬜ Описание — нет данных` | `article.py:413-416` |
| **Прогресс генерации** | `"Подбираю ключевую фразу..."` → `"Генерирую статью..."` → `"Создаю превью..."` | `article.py:1316,1338,1383` |
| **Empty state объяснения** | `"Категория = тема контента (напр. «Кухонная мебель»).\nСоздайте первую..."` | `manage.py:117-121` |
| **Help разделён** | 4 секции: Подключение, Проекты, Категории, Публикация — не стена текста | `help.py:18-97` |
| **Профиль прогноз** | `"Постов в неделю: 14\nТокенов в месяц: ~6080\nХватит на: ~2.5 недели"` | `profile.py:77-84` |
| **Pipeline confirm** | `"МебельКомфорт -> comfort-mebel.ru\nТема: Кухонная мебель\nСтоимость: ~320 ток. \| Баланс: 2450"` | `article.py:1203-1208` |
| **E01 actionable** | `insufficient_balance_kb()` с кнопкой [Пополнить] на шаге генерации | `article.py:1256-1266` |
| **Ошибка публикации** | `"Не удалось опубликовать на WordPress. Попробуйте ещё раз."` + preview KB (retry) | `article.py:1562-1564` |

---

## 1. Критические баги (P0 — исправить немедленно)

### B1. Dual PRIMARY на экране оплаты
- **Файл:** `keyboards/inline.py:303,310` (`package_pay_kb`), `inline.py:323,325` (`subscription_pay_kb`)
- **Проблема:** Обе кнопки (Stars и YooKassa) имеют `style="primary"`. Нарушает правило Bot API 9.4: макс. 1 PRIMARY на экран (UX_TOOLBOX.md §ButtonStyle)
- **Решение:** Stars остаётся `style="primary"`, YooKassa — без style (default)
- **Обоснование:** Stars — нативный метод Telegram, приоритетный для бота
- **Effort:** 4 строки, 5 мин

### B2. Отсутствие exit protection (Pipeline шаги 4-7)
- **Файл:** `routers/publishing/pipeline/article.py` — нет middleware/guard
- **Проблема:** Пользователь может случайно выйти из pipeline через /start или «Меню» (reply-кнопка) во время генерации. Потеря прогресса и токенов. Спецификация UX_PIPELINE §7.5 требует exit protection
- **Решение:** Перехват /start и reply-кнопки «Меню» в состояниях `generating`..`preview` → показать «У вас генерация в процессе. Отменить? [Да/Нет]»
- **Не трогать:** Шаги 1-3 (select project/wp/category) — выход свободный
- **Effort:** ~50 строк

---

## 2. Аудит текстов — что видит и понимает пользователь

### 2.0 Общая оценка текстов

**Что хорошо:**
- Pipeline тексты — лучшие в проекте: короткие, контекстные, с прогрессом
- Readiness checklist — иконки ✅/⬜ + hint + cost — понятно без объяснений
- Категория empty state — объяснение `"Категория = тема контента"` снимает вопросы
- Профиль с прогнозом — `"Хватит на: ~2.5 недели"` реально полезен

**Что плохо:**
- Ошибки — сухие, без помощи (P1-NEW, подробности ниже)
- Welcome — не объясняет зачем бот
- Settings/Notifications — скупые заголовки `"Настройки:"`, `"Уведомления:"`
- Профиль — данные без визуальной иерархии, `ID:` бесполезен для юзера
- Pipeline ошибки — одни хороши (publish retry), другие — мёртвые тупики

### 2.1 Ошибки без помощи (P1 — NEW, самый важный текстовый баг)

**Текущее:** 15+ ошибок — плоский текст `callback.answer(show_alert=True)`, ни одной actionable кнопки.

Примеры из кода:

```text
"Проект не найден."                              — card.py:89
"Категория не найдена."                           — manage.py:75
"Ошибка обновления."                              — settings.py:71
"Ошибка создания платежа."                        — tariffs.py:127
"Пакет не найден."                                — tariffs.py:77
"Подключение не найдено."                         — connections.py:196
"Данные сессии потеряны. Начните заново."          — article.py:1245
"Нет доступных ключевых фраз."                    — article.py:1331
"Превью устарело. Сгенерируйте статью заново."    — article.py:1497
```

**Проблема:** Пользователь видит ошибку и не знает что делать дальше. Нет кнопки "Назад", "Повторить", "В меню". Это **dead-end** — юзер завис.

**Спек (EDGE_CASES.md) требует кнопки:**
- E01: `[Пополнить]` — при нехватке баланса
- E02: `[Проверить подключение]` — WP недоступен
- E10: `[Пополнить] + [Опубликовать текущий]` — перегенерация
- E16: `[Подобрать фразы]` — нет ключевых фраз
- E18: `[Сгенерировать заново] + [К категории]` — превью истекло
- E50: `[Повторить] + [Только превью] + [Другой сайт]` — sub-flow fail

**Grep-доказательство:** `grep "Повторить|Пополнить баланс|Проверить подключение" routers/` → **0 matches**.

**Исключение (уже хорошо):**
- `article.py:1256-1266` — E01 на шаге генерации: `insufficient_balance_kb()` с [Пополнить]
- `article.py:1562-1564` — ошибка публикации: preview KB позволяет retry

**Решение:** `keyboards/errors.py` — 5 шаблонных клавиатур ошибок:

```python
error_insufficient_balance_kb(cost, balance)     # [Пополнить] [Главное меню]
error_connection_failed_kb(project_id)            # [Проверить подключение] [Назад]
error_not_found_kb(back_callback)                 # [Назад] [Главное меню]
error_retry_kb(retry_callback, cancel_callback)   # [Повторить] [Отмена]
error_no_keywords_kb(category_id)                 # [Подобрать фразы] [Назад]
```

### 2.2 Формат ошибок не стандартизирован

**Текущее:** Ошибки отформатированы по-разному:
- `"Категория не найдена."` (одно предложение)
- `"Ошибка VK API: {msg}\nПроверьте токен и попробуйте снова."` (2 строки)
- `"Статья > Ошибка\n\nОшибка списания токенов. Попробуйте позже."` (хедер + текст)

**Решение:** Единый шаблон для pipeline и CRUD:
```
{Header если pipeline}

{Что случилось}: {детали}
{Что делать}
[Кнопки]
```

Пример pipeline: `"Статья > Ошибка\n\nНет ключевых фраз в категории.\nДобавьте фразы для генерации.\n[Подобрать фразы] [К категории]"`
Пример CRUD: `"Подключение не найдено.\n[К подключениям] [Главное меню]"`

---

## 3. Высокоприоритетные улучшения (P1)

### 3.1. Onboarding: welcome текст не объясняет ценность
- **Файл:** `routers/start.py:59-63` (`_build_dashboard_text`, ветка `is_new_user`)
- **Текущее:**
  ```
  Добро пожаловать в SEO Master Bot!
  Вам начислено 1500 токенов (~5 статей на сайт).
  Что хотите сделать?
  ```
- **Проблема:** Не объясняет, зачем бот нужен. Пользователь без контекста не понимает «5 статей» — много или мало. «Что хотите сделать?» — а что можно?
- **Решение:**
  ```
  Добро пожаловать в SEO Master Bot!

  Я создаю SEO-статьи и посты для вашего бизнеса.
  AI напишет → вы проверите → я опубликую на сайт.

  Вам начислено 1500 токенов (~5 статей с картинками).
  Начните с создания проекта — займёт 30 секунд.
  ```

### 3.2. Навигационные заголовки без индикации прогресса
- **Файл:** `routers/publishing/pipeline/article.py` (все шаги)
- **Текущее:** `"Статья > Шаг 1: проект"`, `"Статья > WordPress"`, `"Статья > Подготовка данных"`
- **Проблема:** Нет индикации прогресса. Пользователь не знает, сколько осталось шагов
- **Решение:** `"Статья (1/5) — Проект"` → `"Статья (2/5) — Сайт"` → `"Статья (3/5) — Тема"` → `"Статья (4/5) — Подготовка"` → `"Статья (5/5) — Подтверждение"`
- **Уточнение:** 5 шагов для пользователя (генерация/превью/публикация не считаются — юзер не вводит данные)

### 3.3. Экран настроек — пустой контекст
- **Файл:** `routers/settings.py:25`
- **Текущее:** `"Настройки:"` — одно слово
- **Проблема:** Пользователь не понимает что здесь можно сделать
- **Решение:**
  ```
  Настройки

  Управляйте уведомлениями и настройками бота.
  ```

### 3.4. Профиль — информационная перегрузка
- **Файл:** `routers/profile.py:53-86` (`_format_profile`)
- **Текущее:** Плоский дамп: `ID: 12345\nИмя: Иван Иванов\nРоль: Пользователь\nБаланс: 2450 токенов\nДата регистрации: 01.01.2026\n\nПроектов: 3\nКатегорий: 5\n...`
- **Проблемы:**
  - `ID:` бесполезен для пользователя (нужен только поддержке)
  - Нет визуальной группировки
  - Прогноз далеко внизу — легко пропустить
- **Решение:**
  ```
  Иван Иванов

  Баланс: 2 450 токенов
  Хватит на: ~7 статей (~2.5 недели)

  Проектов: 3 | Категорий: 5
  Активных расписаний: 2

  Постов/нед: 14 | ~6 080 ток./мес
  ```
  `ID` показывать только по кнопке [Поддержка] или [Скопировать ID]

### 3.5. История расходов — нечитаемая
- **Файл:** `routers/profile.py:137-154` (`cb_history`)
- **Текущее:** `"16.02.2026 15:30  Генерация текста  -200 токенов"` — 20 строк подряд
- **Проблемы:**
  - Все записи выглядят одинаково, нет визуальной разницы приход/расход
  - Нет итога периода
  - Нет фильтрации
- **Решение (фаза 1):**
  ```
  Последние операции:

  16.02  Генерация текста     -200 ток.
  16.02  Генерация изображений -120 ток.
  15.02  Покупка токенов      +3000 ток.
  15.02  Возврат токенов       +320 ток.

  Итого за 7 дней: -1 540 ток.
  ```
  Inline-кнопки фильтрации: `[Все] [Списания] [Покупки] [Возвраты]`

### 3.6. Reply KB "Меню" дублирует dashboard
- **Файл:** `routers/start.py`
- **Проблема:** Reply-кнопка "Меню" отправляет **новое** dashboard-сообщение каждый раз. Чат засоряется дубликатами
- **Решение:** Удалять предыдущий dashboard (если доступен) перед отправкой нового. Или хранить `last_dashboard_msg_id` и делать edit

---

## 4. Улучшения средней важности (P2)

### 4.1. Контекстные пустые состояния
- **Файлы:** `inline.py:66-70`, `pipeline.py:121-131`
- **Текущее:** `"У вас нет проектов. Создайте первый проект."` — сухо
- **Решение:** `"Проект = ваш бизнес. Создание за 30 сек — нужны название и специализация."`
- **Аналогично pipeline:** `"В проекте нет категорий."` → `"Категория = тема контента. Например: «Кухонная мебель». Создание за 5 сек."`

### 4.2. Прогресс-бар FSM (ProjectCreate, ConnectWP)
- **Файл:** `routers/projects/create.py` (4 шага), `routers/platforms/connections.py` (3 шага)
- **Текущее:** Каждый шаг — отдельный запрос без контекста
- **Решение:** `"Новый проект (1/4) — Название"` → `"Новый проект (2/4) — Компания"` → ...
- Спек: UX_TOOLBOX.md требует `[====>    ] 2/4`

### 4.3. Confirm с предупреждением о последствиях
- **Файл:** `inline.py:131-137` (`project_delete_confirm_kb`)
- **Текущее:** `"Да, удалить" / "Отмена"` без контекста
- **Решение:** Текст: `"Удалить «{name}»?\n\nБудут удалены: {N} категорий, {M} расписаний, все подключения."` + [Да, удалить (danger)] [Отмена]

### 4.4. Subscription cancel — retention
- **Файл:** `routers/tariffs.py`
- **Текущее:** Сразу `subscription_cancel_confirm_kb`
- **Решение:** Перед подтверждением: `"Вы теряете: {bonus} ток./мес. Подписка действует до {date}."` + [Приостановить на время] [Отменить] [Оставить]

### 4.5. Профиль — низкий баланс CTA
- **Файл:** `routers/profile.py:75-84`
- **Текущее:** `"Хватит на: ~2.5 недели"` — просто текст
- **Решение:** Если <2 недель → `"Баланс заканчивается через ~{N} дней. [Пополнить]"`. Если 0 → красное предупреждение

### 4.6. Referral — копирование ссылки
- **Файл:** `inline.py:238-246` (`profile_referral_kb`)
- **Текущее:** Только URL-кнопка `"Поделиться"`
- **Решение:** Добавить `"Скопировать ссылку"` (callback → отправить ссылку отдельным сообщением)

### 4.7. Referral текст — мотивация
- **Файл:** `routers/profile.py:176-180`
- **Текущее:** `"Вы получаете 10% от каждой покупки..."` — абстрактно
- **Решение:** Добавить пример: `"Друг купил 3000 ток. → вам +300 ток. бонусом"`. Если 0 приглашений — `"Пригласите друга и получите бонус с его первой покупки!"`

### 4.8. Стоимость в справке
- **Спек:** PRD.md §Токеномика определяет стоимость
- **Текущее:** Нигде в UI не показана сводная таблица стоимости
- **Решение:** Добавить в `help:publish` или отдельный раздел:
  ```
  Стоимость:
  - Статья (2000 сл. + 4 фото): ~320 ток.
  - Пост в соцсети + фото: ~40 ток.
  - Ключевые фразы (100 шт.): 100 ток.
  - Аудит сайта: 50 ток.
  ```

---

## 5. Стратегические улучшения (P3 — backlog)

### 5.1. texts/ модуль
- **Текущее:** Все строки hardcoded в роутерах
- **Проблема:** Дублирование, невозможность A/B тестирования
- **Решение:** `texts/` модуль с константами: `texts/dashboard.py`, `texts/pipeline.py`, `texts/errors.py`

### 5.2. Проактивные уведомления о балансе
- **Текущее:** Уведомление только при попытке генерации (E01)
- **Решение:** При балансе < 3 статей → push-уведомление `"Осталось на ~3 статьи. [Пополнить]"`

### 5.3. Onboarding wizard (3 шага)
- **Текущее:** Welcome → Dashboard → юзер разбирается сам
- **Решение:** Wizard: `Создайте проект` → `Подключите WordPress` → `Напишите первую статью`

### 5.4. Smart CTA на Dashboard
- **Текущее:** Фиксированная кнопка «Написать статью»
- **Решение:** Адаптивный CTA:
  - 0 проектов → «Создать первый проект (30 сек)»
  - Есть проект, нет WP → «Подключить WordPress»
  - Всё есть → «Написать статью» + «Пост в соцсети»

### 5.5. Контекстный help [?]
- Inline-кнопки `[?]` в контексте: рядом с «Ключевые фразы» — «Что это?»
- Callback `help:context:{topic}` → короткий ответ

---

## 6. Матрица приоритетов

| ID | Описание | P | Effort | Impact | Волна |
|----|----------|---|--------|--------|-------|
| B1 | Dual PRIMARY на оплате | P0 | 5 мин | Соответствие спеку | 1 |
| B2 | Exit protection (pipeline 4-7) | P0 | 2ч | Защита от потери токенов | 1 |
| 2.1 | Error keyboards (keyboards/errors.py) | P1 | 1ч | Dead-end prevention | 1 |
| 2.2 | Стандартный формат ошибок | P1 | 1.5ч | Консистентность | 1 |
| 3.1 | Welcome текст | P1 | 15 мин | Conversion | 2 |
| 3.2 | Pipeline breadcrumbs (1/5) | P1 | 30 мин | Ориентация | 2 |
| 3.3 | Settings заголовок | P1 | 5 мин | Контекст | 2 |
| 3.4 | Профиль переформатирование | P1 | 30 мин | Читаемость | 2 |
| 3.5 | История: формат + фильтры | P1 | 1.5ч | Навигация | 2 |
| 3.6 | Reply Меню dedup | P1 | 30 мин | Чистота чата | 2 |
| 4.1 | Контекстные пустые состояния | P2 | 30 мин | Понятность | 3 |
| 4.2 | Прогресс FSM (1/4) | P2 | 45 мин | Ориентация | 3 |
| 4.3 | Confirm с последствиями | P2 | 30 мин | Безопасность | 3 |
| 4.4 | Subscription retention | P2 | 1ч | Revenue | 3 |
| 4.5 | Low balance CTA | P2 | 30 мин | Revenue | 3 |
| 4.6 | Referral copy + мотивация | P2 | 30 мин | Sharing | 3 |
| 4.7 | Referral текст мотивация | P2 | 15 мин | Conversion | 3 |
| 4.8 | Стоимость в справке | P2 | 20 мин | Прозрачность | 3 |
| 5.1 | texts/ модуль | P3 | 4ч | Maintainability | 4 |
| 5.2 | Proactive balance alerts | P3 | 2ч | Revenue | 4 |
| 5.3 | Onboarding wizard | P3 | 6ч | Conversion | 4 |
| 5.4 | Smart CTA | P3 | 2ч | Conversion | 4 |
| 5.5 | Contextual help [?] | P3 | 3ч | UX | 4 |

---

## 7. Волны реализации

### Волна 1 — Критическое + Error Recovery (~4ч)
**Цель:** Устранить баги и dead-end ошибки. Юзер перестаёт «застревать».

1. B1: Fix dual PRIMARY на оплате (4 строки)
2. B2: Exit protection для pipeline `generating`..`preview`
3. `keyboards/errors.py` — 5 шаблонных error-клавиатур
4. Применить error KB в роутерах (E01, E02, E16, E18, E50)
5. Стандартизировать формат ошибок (header + что случилось + что делать + кнопки)

**Файлы:** `keyboards/inline.py`, `keyboards/errors.py` (new), `article.py`, `manage.py`, `connections.py`, `tariffs.py`
**Проверка:** pytest + ручной прогон pipeline + проверка ошибок

### Волна 2 — Тексты и Читаемость (~3.5ч)
**Цель:** Юзер понимает что делает бот, где он находится, и куда идти.

1. Welcome текст (объяснение ценности)
2. Pipeline breadcrumbs `(1/5)` → `(5/5)`
3. Settings заголовок (+ уведомления заголовок)
4. Профиль: новый формат (баланс сверху, группировка, без ID)
5. История: формат (приход/расход визуально) + фильтры
6. Reply Меню → не дублировать dashboard

**Файлы:** `start.py`, `article.py` (headers), `settings.py`, `profile.py`
**Проверка:** pytest + ручной прогон от /start до профиля

### Волна 3 — Safety + Conversion (~3.5ч)
**Цель:** Защита от ошибок пользователя, увеличение retention и sharing.

1. Контекстные пустые состояния (тексты-объяснения)
2. Прогресс FSM (project create 1/4, connect WP 1/3)
3. Confirm с последствиями (имя + каскад)
4. Subscription retention screen
5. Low balance CTA в профиле
6. Referral: copy link + мотивирующий текст
7. Стоимость в справке

**Файлы:** `inline.py`, `pipeline.py` (texts), `create.py`, `card.py`, `tariffs.py`, `profile.py`, `help.py`
**Проверка:** pytest + E42 + E01 + new user flow

### Волна 4 — Architecture (backlog)
**Цель:** Стратегические улучшения для масштабирования.

1. `texts/` модуль — вынести строки из роутеров
2. Proactive balance notifications
3. Onboarding wizard (3 шага)
4. Smart adaptive CTA
5. Contextual help [?]

**Проверка:** Полный интеграционный тест

---

## 8. Технические принципы

1. **Не ломать services/.** UI-улучшения не затрагивают бизнес-логику — только роутеры и клавиатуры
2. **ButtonStyle contract.** Макс. 1 `primary` на экран. `success` для confirm. `danger` для delete/cancel. Default для навигации
3. **guard_callback_message.** Все callback-хендлеры: `msg = await guard_callback_message(callback)`. Не трогать
4. **edit_text vs answer.** Inline-кнопки → `edit_text`. Reply-кнопки → `answer`. Не смешивать
5. **Readiness — enrichers, не blockers.** Все 4 пункта опциональны. «Всё OK — генерировать» всегда активна
6. **Ошибки — всегда с выходом.** Каждое сообщение об ошибке заканчивается минимум 1 кнопкой навигации

---

## 9. Метрики успеха

| Метрика | Текущее | После Волны 1 | После Волны 3 |
|---------|---------|---------------|---------------|
| Ошибок-тупиков (dead-end) | 15+ | 0 | 0 |
| ButtonStyle нарушений | 2 экрана | 0 | 0 |
| Ошибки с actionable кнопками | 1 из 15 E-кодов | 6+ | 12+ |
| Pipeline exit protection | 0% | 100% | 100% |
| Pipeline прогресс (1/N) | нет | есть | есть |
| Welcome объясняет ценность | нет | да | wizard |

---

*Документ обновляется по мере реализации волн. После каждой волны — gap-finder + verify-spec.*
