# UX Specification: Pipeline

> **Версия:** 1.0
> **Дата:** 2026-02-17
> **Назначение:** Полная UX-спецификация Pipeline-воронки — основного способа публикации контента.
> **Парный документ:** [UX_TOOLBOX.md](UX_TOOLBOX.md) — управление данными (проекты, категории, подключения).

---

## 1. Концепция

### 1.1. Проблема

Пользователь хочет одно из двух:
1. **«Напиши и опубликуй статью на мой сайт»**
2. **«Напиши и опубликуй пост в мой канал/группу»**

Всё остальное (проекты, категории, подключения, ключевики, описания, цены) — **средства**, а не цели. Пользователь не должен знать архитектуру — он должен получить результат.

### 1.2. Решение: Goal-Oriented Pipeline

**Одна кнопка запускает весь пайплайн.** Бот сам проверяет, чего не хватает (readiness check), и предлагает дозаполнить по ходу. Что не хочешь — пропускаешь. Обязательное создаётся на месте. Результат — публикация.

### 1.3. Два режима

| Режим | Для кого | Вход | Что даёт |
|-------|----------|------|----------|
| **Pipeline** | Все пользователи | «Написать статью» / «Пост в соцсети» | Быстрый путь к результату, бот ведёт |
| **Toolbox** | Power users | «Мои проекты» → карточка → инструменты | Полный контроль над каждой настройкой |

Публикация контента — **ТОЛЬКО через Pipeline**. Toolbox — для управления данными.

---

## 2. Dashboard

### 2.1. Новый пользователь (0 проектов)

```
"Привет! Я помогу создать и опубликовать SEO-контент.
 Вам начислено 1500 токенов (~5 статей на сайт).

 Что хотите сделать?"

[Написать статью на сайт]        ← PRIMARY
[Создать пост в соцсети]
───────────────────────
[Мои проекты]  [Профиль]  [Токены]
```

### 2.2. Returning user (есть проекты)

```
"Баланс: 2 450 токенов
 Проектов: 3 | Активных расписаний: 5
 Хватит на: ~7 статей"

[Написать статью на сайт]        ← PRIMARY
[Создать пост в соцсети]
───────────────────────
[Мои проекты]  [Профиль]  [Токены]
```

### 2.3. Returning user (0 проектов, был ранее)

```
"Баланс: 1 500 токенов
 У вас пока нет проектов.
 Создайте первый — это займёт 30 секунд."

[Написать статью на сайт]        ← PRIMARY
[Создать пост в соцсети]
───────────────────────
[Мои проекты]  [Профиль]  [Токены]
```

### 2.4. Контекстный порядок CTA

| Подключения | PRIMARY CTA | Логика |
|-------------|-------------|--------|
| Есть WP, нет соцсетей | `[Написать статью]` | Единственный путь к публикации |
| Есть соцсети, нет WP | `[Опубликовать пост]` | WP нет → статья невозможна без превью |
| Есть и WP, и соцсети | `[Написать статью]` | Статья — основной продукт |
| Нет подключений (новичок) | `[Написать статью]` | Pipeline сам предложит подключить |

### 2.5. «Хватит на: ~N статей»

Пользователь считает в статьях, а не в неделях. Формула: `floor(balance / avg_article_cost)`, где `avg_article_cost = 320` (дефолт) или рассчитывается из последних 10 публикаций пользователя.

### 2.6. Возобновление pipeline

Если в Redis есть активный checkpoint (`pipeline:{user_id}:state`, TTL 24h), при входе в Dashboard:

```
"У вас есть незавершённая статья:
 Проект: Мебель Комфорт
 Остановились на: подготовка данных

 [Продолжить] ← SUCCESS    [Начать заново]    [Отменить] ← DANGER"
```

callback_data: `pipeline:resume`, `pipeline:restart`, `pipeline:cancel`

### 2.7. Нулевой/отрицательный баланс

Баланс 0:

```
"Баланс: 0 токенов
 Для генерации контента нужно пополнить баланс.

 [Пополнить баланс]          ← PRIMARY
 ───────────────────────
 [Мои проекты]  [Профиль]  [Токены]"
```

Отрицательный баланс:

```
"Баланс: −50 токенов
 Задолженность будет списана при следующем пополнении.

 [Пополнить баланс]          ← PRIMARY
 ───────────────────────
 [Мои проекты]  [Профиль]  [Токены]"
```

Кнопки `[Написать статью]` и `[Создать пост]` НЕ убираются -- Pipeline сам покажет ошибку E01 при недостатке баланса.

---

## 3. Reply-клавиатура

Всегда видна внизу экрана:

```
[Меню]  [Написать статью]  [Создать пост]
[АДМИНКА]*  (только для ADMIN_ID)
```

- `[Меню]` → новое dashboard-сообщение
- `[Написать статью]` → запускает ArticlePipelineFSM
- `[Создать пост]` → запускает SocialPipelineFSM
- `[Главное меню]` (inline) → editMessageText на dashboard

---

## 4. Pipeline «Написать статью на сайт»

### 4.1. Полная схема (ArticlePipelineFSM — 25 состояний)

```
[Написать статью на сайт]
  │
  ├─ ШАГ 1: Выбор проекта
  │   ├── 0 проектов → "Для начала создадим проект — это 30 секунд."
  │   │    → встроенный ProjectCreate (4 вопроса, см. UX_TOOLBOX §2.3) → автовозврат в pipeline
  │   ├── 1 проект → автовыбор, переход к шагу 2
  │   └── >1 проект → "Статья (1/5) — Проект
  │                     Для какого проекта?"
  │        [Мебель Комфорт]  [Стоматология]  [Автосервис]  ...
  │        (пагинация по 8)
  │
  │   callback_data: pipeline:article:{project_id}:select
  │                  page:pipeline_projects:{page_num}
  │
  ├─ ШАГ 2: WordPress подключён?
  │   ├── 1 подключение → автовыбор, переход к шагу 3
  │   └── 0 подключений → "Статья (2/5) — Сайт
  │        Для публикации нужен WordPress-сайт. Подключим?"
  │        [Подключить WordPress]  ← PRIMARY    [Только превью (без публикации)]
  │        │
  │        ├── [Подключить] → встроенный ConnectWP (3 шага) → автовозврат
  │        └── [Только превью] → pipeline продолжается,
  │             на шаге публикации будет только Telegraph-превью
  │
  │   Правило: 1 проект = макс. 1 WordPress. Для другого сайта — новый проект.
  │
  │   callback_data: pipeline:article:connect_wp
  │                  pipeline:article:preview_only
  │
  ├─ ШАГ 3: Выбор категории (темы)
  │   ├── 0 категорий → "Статья (3/5) — Тема
  │   │    О чём будет статья? Назовите тему."
  │   │    → встроенный CategoryCreate (1 вопрос, см. UX_TOOLBOX §7.3) → автовозврат
  │   ├── 1 категория → автовыбор, переход к шагу 4
  │   └── >1 категорий → "Статья (3/5) — Тема
  │        Какая тема?"
  │        [Кухонная мебель]  [Шкафы-купе]  [Диваны]  ...
  │
  │   callback_data: pipeline:article:{project_id}:cat:{cat_id}
  │
  ├─ ШАГ 4: Readiness check
  │   │
  │   │  Бот проверяет чеклист и показывает ТОЛЬКО незаполненные пункты.
  │   │  Если всё заполнено — шаг пропускается целиком.
  │   │  Все пункты на ОДНОМ экране (чеклист).
  │   │
  │   │  "Статья (4/5) — Подготовка
  │   │
  │   │   Можно улучшить статью:
  │   │   Ключевые фразы — SEO-оптимизация
  │   │   Описание компании — точность контекста
  │   │   Цены — заполнено
  │   │   Изображения — 4 AI (авто)
  │   │
  │   │   [Подобрать ключевики (100 ток.)]
  │   │   [Описание (20 ток.)]
  │   │   [Всё ОК — генерировать →]      ← SUCCESS
  │   │
  │   │   Ориентировочная стоимость: ~320 ток."
  │   │
  │   │  После заполнения пункта — возврат на чеклист с обновлёнными галочками:
  │   │  "✓ Подобрано 12 кластеров (100 фраз). Что ещё?"
  │   │
  │   ├── 4a. Ключевые фразы
  │   │    [Подобрать автоматически (100 фраз — 100 токенов)]
  │   │    [Настроить параметры]    → products → geography → quantity
  │   │    [Загрузить свои]         → KeywordUpload
  │   │    [Назад к чеклисту]
  │   │    │
  │   │    ├── [Подобрать автоматически] → company_name + specialization.
  │   │    │    Если нет company_city — один доп. вопрос:
  │   │    │    "В каком городе ваш бизнес? (для точных SEO-фраз)"
  │   │    │    [Москва] [СПб] [Ввести свой] [Вся Россия]
  │   │    │    Город сохраняется в проект.
  │   │    │    → автовозврат к чеклисту
  │   │    ├── [Настроить] → inline KeywordGen → автовозврат к чеклисту
  │   │    └── [Загрузить] → inline KeywordUpload → автовозврат к чеклисту
  │   │
  │   ├── 4b. Описание компании/категории
  │   │    "Добавить описание? AI напишет точнее с контекстом о вашей компании."
  │   │    [Сгенерировать AI (20 токенов)]
  │   │    [Написать вручную]
  │   │    [Назад к чеклисту]
  │   │    │
  │   │    ├── [Сгенерировать] → AI генерирует → показ → [Сохранить] / [Перегенерировать]
  │   │    │    → "✓ Описание сохранено." → автовозврат к чеклисту
  │   │    └── [Вручную] → {Введите описание} → сохранить → автовозврат к чеклисту
  │   │
  │   ├── 4c. Цены
  │   │    "Добавить прайс-лист? В статье будут реальные цены ваших товаров."
  │   │    [Добавить текстом]
  │   │    [Загрузить Excel]
  │   │    [Назад к чеклисту]
  │   │
  │   └── 4d. Изображения (только AI)
  │        "В статье будет 4 AI-изображения по теме."
  │        [AI генерация (120 токенов)]        ← дефолт
  │        [Настроить количество]               → выбор 0-10
  │        [Назад к чеклисту]
  │
  │   callback_data: pipeline:readiness:{item}
  │
  ├─ ШАГ 5: Подтверждение
  │   "Статья (5/5) — Подтверждение
  │
  │    Мебель Комфорт → comfort-mebel.ru
  │    Тема: Кухонная мебель
  │    Ключевики: 12 кластеров | Изображения: 4 AI
  │
  │    Стоимость: ~320 ток. | Баланс: 2 450"
  │
  │   [Создать статью]        ← SUCCESS
  │   [Вернуться к чеклисту]
  │   [Отмена]
  │
  │   callback_data: pipeline:article:confirm
  │                  pipeline:article:back_readiness
  │                  pipeline:article:cancel
  │
  ├─ ШАГ 6: Генерация (~60 сек)
  │   "Собираю данные из Google..."          (0-5с)
  │   "Анализирую конкурентов..."            (5-15с)
  │   "Генерирую текст и изображения..."     (15-50с)
  │   "Готовлю предпросмотр..."              (50-60с)
  │   (параллельный pipeline: текст + изображения через asyncio.gather)
  │
  ├─ ШАГ 7: Превью + публикация
  │   "Статья — Превью
  │    «Кухни на заказ в Москве: как выбрать и не переплатить»
  │    2 150 слов, 4 картинки, 6 заголовков
  │    Кластер: Кухни на заказ (15 фраз)
  │    320 токенов
  │    telegra.ph/Kuhni-na-zakaz-123
  │    Превью приблизительное. На сайте статья
  │       будет выглядеть в стиле вашей WP-темы."
  │
  │   Лимит перегенераций (FSM_SPEC §2.2):
  │   2 бесплатных, далее платно (~320 ток.).
  │   Счётчик в state.data["regen_count"].
  │
  │   Вариант A (есть WP):
  │   [Опубликовать]          ← SUCCESS
  │   [Перегенерировать]      (или [Перегенерировать (~320 ток.)] если regen_count >= 2)
  │   [Отмена — вернуть токены] ← DANGER
  │
  │   Вариант B (только превью, нет WP):
  │   [Подключить WordPress и опубликовать] ← SUCCESS
  │   [Скопировать HTML]
  │   [Перегенерировать]
  │   [Отмена — вернуть токены] ← DANGER
  │
  │   callback_data: pipeline:article:publish
  │                  pipeline:article:regen
  │                  pipeline:article:cancel_refund
  │
  └─ ШАГ 8: Результат + next actions
      "Опубликовано!
       https://comfort-mebel.ru/kuhni-na-zakaz/
       Списано: 320 токенов | Остаток: 2 130"

      [Ещё статью]                    ← PRIMARY → pipeline с шага 3
      [Настроить автопубликацию]      → ScheduleSetup inline
      [Главное меню]

      callback_data: pipeline:article:more
                     pipeline:article:schedule
                     nav:dashboard
```

### 4.2. Поведение «Ещё статью»

Pipeline запоминает проект и сайт. Повторный запуск показывает контекст:

```
[Ещё статью]
  → "Статья (3/5) — Мебель Комфорт (comfort-mebel.ru)
     Какая тема?"
     [Кухонная мебель]  [Шкафы-купе]  [Диваны]
     [Другой проект]

  ├── Категорий >1 → список (как выше)
  ├── Категория 1 → автовыбор
  └── Всё заполнено → сразу подтверждение (шаг 5)
```

**Для returning user с настроенным проектом: 2-3 нажатия до генерации.**

### 4.3. Inline handlers (не FSM delegation)

Pipeline **сам содержит** states для каждого sub-flow — это НЕ вызов чужого FSM, а inline вопросы внутри PipelineFSM. Бот **автоматически возвращает в pipeline** после заполнения.

```
ArticlePipelineFSM
  ├── state: select_project
  ├── state: create_project_*        # inline: 4 вопроса → ProjectRepository
  ├── state: check_wp / select_wp
  ├── state: connect_wp_*            # inline: 3 вопроса → ConnectionService
  ├── state: select_category
  ├── state: create_category         # inline: 1 вопрос → CategoryRepository
  ├── state: readiness               # чеклист — один экран
  ├── state: readiness_keywords_*    # inline: 3 вопроса → KeywordService
  ├── state: readiness_description   # inline: 1 confirm → AIOrchestrator
  ├── state: readiness_prices        # inline: text/excel → CategoryRepository
  ├── state: readiness_photos        # inline: AI choice
  ├── state: confirmation
  ├── state: generating
  ├── state: preview
  └── state: published
```

### 4.4. Progressive Readiness (адаптивный чеклист)

Readiness check (шаг 4) адаптируется к опыту пользователя **глобально** (не per-project):

| Условие | Показываемые пункты (если не заполнены) | Обязательные |
|---------|----------------------------------------|--------------|
| **Первый запуск** (0 публикаций) | Ключевики + описание | Ключевики |
| **2-5 публикаций** | Ключевики + описание + цены + изображения | Ключевики |
| **>5 публикаций** | Все пункты | Ключевики |
| **Всё уже заполнено** | Шаг пропускается целиком | — |

**Ключевые фразы** — единственный блокирующий пункт. Описание, цены, изображения — опциональные enrichers.

### 4.5. Quick confirm — «Как в прошлый раз»

При ручном запуске после настройки расписания:

```
"Статья (5/5) — Мебель Комфорт → comfort-mebel.ru
 Последняя тема: Кухонная мебель

 [Та же тема → генерировать]     ← SUCCESS — 1 клик до генерации
 [Другая тема]                    ← список категорий
 [Другой проект]"
```

Основано на `publication_logs ORDER BY created_at DESC LIMIT 1`.

---

## 5. Pipeline «Опубликовать пост в соцсети»

### 5.1. Полная схема (SocialPipelineFSM — 28 состояний)

```
[Опубликовать пост в соцсети]
  │
  ├─ ШАГ 1: Выбор проекта
  │   (аналогично статье: 0→создать, 1→авто, >1→список)
  │
  ├─ ШАГ 2: Выбор подключения (платформа + канал в одном шаге)
  │   │
  │   │  Показываются конкретные подключения, а не платформы.
  │   │
  │   ├── Есть подключения → "Пост (2/5) — Платформа"
  │   │    [Telegram: @comfort_channel]
  │   │    [VK: Мебель Комфорт (группа)]
  │   │    [Pinterest: Мебельные идеи (доска: Интерьеры)]
  │   ├── 1 подключение → автовыбор
  │   └── 0 подключений → "Подключите соцсеть для публикации"
  │        [Подключить Telegram]
  │        [Подключить VK]
  │        [Подключить Pinterest]
  │        → встроенный Connect* FSM → автовозврат
  │
  │   callback_data: pipeline:social:{project_id}:conn:{conn_id}
  │
  ├─ ШАГ 3: Выбор категории (темы)
  │   (аналогично статье: 0→создать, 1→авто, >1→список)
  │
  ├─ ШАГ 4: Readiness check (сокращённый)
  │   │  Для соцпостов: ключевые фразы и описание.
  │   │  Цены, изображения — НЕ спрашивать.
  │   │  Если оба заполнены — шаг пропускается.
  │   │
  │   │  "Пост (4/5) — Подготовка
  │   │   Ключевые фразы — релевантные хештеги
  │   │   Описание — заполнено
  │   │   [Подобрать ключевики (50 ток.)]
  │   │   [Всё ОК — генерировать →]"      ← SUCCESS
  │
  ├─ ШАГ 5: Подтверждение
  │   "Пост (5/5) — Подтверждение
  │
  │    Telegram: @comfort_channel
  │    Тема: Кухонная мебель
  │    Стоимость: ~40 ток. | Баланс: 2 450"
  │
  │   [Создать пост] ← SUCCESS    [Вернуться к чеклисту]    [Отмена]
  │
  │   callback_data: pipeline:social:confirm
  │
  ├─ ШАГ 6: Генерация → ревью
  │   "Пост — Ревью
  │    Пост для Telegram:
  │    ─────────────
  │    [текст поста в чате]
  │    ─────────────
  │    + 1 изображение"
  │
  │   [Опубликовать] ← SUCCESS    [Перегенерировать]*    [Отмена] ← DANGER
  │   * 2 бесплатных перегенерации, далее платно (~40 ток.).
  │
  │   callback_data: pipeline:social:publish
  │                  pipeline:social:regen
  │                  pipeline:social:cancel_refund
  │
  └─ ШАГ 7: Результат + next actions
      "Пост опубликован в @comfort_channel!
       Списано: 40 токенов | Остаток: 2 410"

      [Адаптировать для VK (~10 ток.)]       ← если есть VK
      [Адаптировать для Pinterest (~10 ток.)] ← если есть Pinterest
      [Ещё пост]                                ← PRIMARY
      [Настроить автопубликацию]
      [Главное меню]

      Кнопки кросс-постинга показываются для ВСЕХ оставшихся
      подключённых платформ.

      callback_data: pipeline:crosspost:{conn_id}
                     pipeline:social:more
                     pipeline:social:schedule
                     nav:dashboard
```

---

## 6. Кросс-постинг

После публикации поста предлагается адаптация для других подключённых платформ. Адаптация текста (длина, хештеги, форматирование) без повторной генерации с нуля.

### 6.1. Стоимость

- Кросс-пост: `ceil(adapted_word_count / 100) * 10` (~10 токенов для поста ~100 слов)
- Изображение: переиспользуется из оригинального поста (0 токенов)
- `token_expenses.operation_type`: `cross_post`
- MODEL_CHAINS: `task_type: "cross_post"` (DeepSeek, дешёвая трансформация)

### 6.2. Обязательный ревью

Адаптированный пост **всегда проходит ревью** перед публикацией:

```
[Адаптировать для VK (~10 ток.)]
  → "Пост адаптирован для VK:
     ─────────────
     [текст поста]
     ─────────────

     [Опубликовать в VK] ← SUCCESS    [Отмена]"
```

callback_data: `pipeline:crosspost:{conn_id}:publish`

---

## 7. Автопубликация в контексте Pipeline

### 7.1. Предложение расписания после первой публикации

```
Шаг 8 (после публикации):
  "Статья опубликована!

   Хотите автоматические публикации по расписанию?
   Бот будет сам генерировать и публиковать статьи.

   [Каждый будний день в 10:00]     ← quick preset
   [Пн, Ср, Пт в 10:00]            ← quick preset
   [Настроить вручную]              → полный ScheduleSetup FSM
   [Позже]"
```

Quick presets создают расписание в 1 клик. Показывается мягко, без навязывания. Если `[Позже]` — не повторять до 5-й публикации.

### 7.2. Автопубликация без участия юзера

Автопубликация по расписанию работает **без pipeline** — QStash cron механизм:
- QStash → webhook → генерация → публикация → уведомление
- Telegraph-превью не создаётся
- При ошибке: возврат токенов + уведомление с причиной

### 7.3. Авто-кросс-постинг

Если у расписания настроены `cross_post_connection_ids`, после успешной публикации ведущего поста:

1. **Lead publish** — генерация и публикация на ведущей платформе
2. **Cross-post chain** — для каждого зависимого подключения:
   - Проверка: подключение активно?
   - Проверка: достаточно токенов? (~10 ток/пост)
   - Списание токенов (`cross_post` operation_type)
   - AI-адаптация текста (`SocialPostService.adapt_for_platform()`)
   - Публикация на целевой платформе
   - Логирование с `content_type="cross_post"`
3. **Partial failure OK** — ведущий пост остаётся опубликованным, ошибочные кросс-посты рефундятся
4. **Одно уведомление** — пользователь получает одно сообщение со всеми результатами:

```
"Автопубликация выполнена: ключевая фраза
 ✓ Telegram: t.me/...
 ✓ VK: vk.com/...
 ✗ Pinterest: ошибка подключения"
```

5. **Insufficient balance** — если баланса не хватает для кросс-поста, оставшиеся пропускаются (break)
6. **Connection deleted** — `cleanup_cross_post_refs()` автоматически убирает ID из массива при удалении подключения

---

## 8. Обработка ошибок в Pipeline

### 8.1. Недостаточно токенов

```
"Недостаточно токенов!
 Нужно: ~320 | Баланс: 50

 [Пополнить баланс] ← PRIMARY  → экран Токены → после оплаты → автовозврат
 [Отмена]"
```

Pipeline state сохраняется. После пополнения: «Баланс пополнен! Продолжить генерацию?» `[Продолжить]` `[Отмена]`

### 8.2. WordPress не отвечает

```
"Не удалось подключиться к comfort-mebel.ru
 Возможные причины: сайт недоступен, Application Password истёк.

 [Повторить попытку]   ← PRIMARY
 [Другой сайт]         → выбор из подключённых
 [Только превью]       → генерация без публикации
 [Отмена]"
```

### 8.3. Генерация не удалась

```
"Ошибка генерации текста.
 Токены возвращены: 200

 [Повторить]           ← PRIMARY → заново с того же шага
 [Другая тема]         → шаг 3 (выбор категории)
 [Главное меню]"
```

### 8.4. FSM конфликт

Если пользователь в другом FSM и нажимает «Написать статью»:
- Текущий FSM автоматически сбрасывается (E29)
- Pipeline FSM стартует

### 8.5. Защита от случайного выхода

Если пользователь нажимает `[Меню]` во время pipeline:

**Шаги 1-3** (выбор проекта/WP/категории): выход без подтверждения.

**Шаги 4-7** (readiness → генерация → превью): подтверждение:

```
"Вы в процессе создания статьи (подготовка данных).
 Прервать? Прогресс будет сохранён 24 часа."

[Продолжить pipeline]   ← PRIMARY
[Выйти в меню]          ← DANGER
```

### 8.6. Таймаут pipeline

Pipeline state в Redis с TTL 24h. Через 2 часа — state сохранён. После 24h — очищен, начать заново.

### 8.7. Множественные pipeline

Один FSM state per user — одновременно два pipeline НЕ поддерживаются.

```
"У вас активен pipeline:
 Статья для Мебель Комфорт (подготовка данных)

 [Прервать и начать новый] ← DANGER    [Вернуться к текущему] ← PRIMARY"
```

Checkpoint первого pipeline сохраняется 24h для возврата.

### 8.8. Возврат из YooKassa-оплаты

Webhook handler проверяет `pipeline:{user_id}:state` в Redis:

```
"Баланс пополнен! Продолжить создание статьи?
 Проект: Мебель Комфорт | Тема: Кухонная мебель

 [Продолжить] ← SUCCESS    [Нет]"
```

### 8.9. Ошибки Social Pipeline

Ошибки Article Pipeline (§8.1-8.3) покрывают общие случаи (баланс, генерация). Ниже — специфичные для соцсетей.

#### Telegram: бот не админ канала

```
"Бот не является администратором @comfort_channel.
 Добавьте бота админом с правом «Публикация сообщений».

 [Проверить снова]       ← PRIMARY
 [Другой канал]          → список подключений
 [Отмена]"
```

#### VK: ошибка API

```
"Ошибка VK API: {описание ошибки}
 Возможно, токен истёк или группа заблокирована.

 [Повторить]             ← PRIMARY
 [Переподключить VK]     → ConnectVKFSM
 [Другое подключение]    → список подключений
 [Отмена]"
```

#### Pinterest: rate limit / ошибка

```
"Pinterest ограничил запросы. Попробуйте через 15 минут.

 [Повторить через 15 мин]   ← PRIMARY
 [Другое подключение]       → список подключений
 [Отмена]"
```

#### Публикация не удалась (любая платформа)

```
"Не удалось опубликовать в {платформа}: {канал}.
 Токены возвращены: {amount}

 [Повторить]             ← PRIMARY → та же платформа
 [Другое подключение]    → шаг 2 Social Pipeline
 [Сохранить как черновик] → пост сохранён в pipeline checkpoint
 [Главное меню]"
```

callback_data: `pipeline:social:retry`, `pipeline:social:change_conn`, `pipeline:social:draft`, `nav:dashboard`

---

## 9. AI-изображения

### 9.1. Логика выбора

```
Приоритет:
1. AI-генерация (Gemini через OpenRouter) — дефолт
2. Без изображений — если пользователь выбрал 0
```

Загрузка пользовательских фото убрана из v2. Только AI-изображения.

### 9.2. В pipeline (шаг 4d)

```
"В статье будет 4 AI-изображения по теме.

 [AI генерация (120 токенов)]    ← дефолт
 [Настроить количество]          → выбор 0-10
 [Назад к чеклисту]"
```

### 9.3. Стоимость

- AI-изображение: 30 токенов/шт
- Дефолт: 4 изображения = 120 токенов
- Настройки стилей (камеры, ракурсы, негативные промпты) — в toolbox (карточка категории → «Настройки контента»)

---

## 10. Технические детали

### 10.1. Новые файлы

```
routers/publishing/pipeline/
  __init__.py           — регистрация роутеров
  article.py            — ArticlePipelineFSM (25 состояний)
  social.py             — SocialPipelineFSM (28 состояний)
  readiness.py          — inline readiness check handlers

services/
  readiness.py          — ReadinessService

keyboards/
  pipeline.py           — клавиатуры для pipeline
```

### 10.2. ReadinessService

```python
@dataclass
class ReadinessReport:
    has_keywords: bool
    keyword_count: int
    has_description: bool
    has_prices: bool
    image_count: int
    estimated_cost: int          # tokens
    user_balance: int
    is_sufficient_balance: bool

    @property
    def all_filled(self) -> bool:
        """If all filled — readiness check is skipped."""
        return self.has_keywords and self.has_description

    @property
    def missing_items(self) -> list[str]:
        """Only unfilled items to show in pipeline."""
        ...
```

### 10.3. Pipeline checkpoint (отдельный Redis-ключ)

Redis key: `pipeline:{user_id}:state`, TTL 24h.

Хранится **отдельно от FSM state.data** — sub-flow не может перезаписать pipeline данные.

```json
{
    "pipeline_type": "article",
    "current_step": "readiness",
    "project_id": 5,
    "connection_id": 12,
    "category_id": 8,
    "skipped_keywords": false,
    "skipped_description": true,
    "skipped_prices": true,
    "photo_source": "ai",
    "image_count": 4,
    "estimated_cost": 320
}
```

### 10.4. Sub-flow механизм (inline handlers)

Pipeline **не вызывает** существующие FSM. Вместо этого inline handlers переиспользуют Service Layer:

- KeywordGeneration: 3 вопроса → `KeywordService.generate()` (~30-50 строк)
- ConnectWP: 3 вопроса → `ConnectionService.create()` (~30-50 строк)
- CategoryCreate: 1 вопрос → `CategoryRepository.create()` (~15 строк)
- Description: 1 подтверждение → `AIOrchestrator.generate("description")` (~20 строк)

### 10.5. Обновление чеклиста после sub-flow

**Простые sub-flows** (1 сообщение → 1 ответ): `editMessageText` чеклиста.

**Сложные sub-flows** (3+ промежуточных сообщений): `deleteMessage` старого чеклиста + новое сообщение внизу чата.

### 10.6. Валидация WP на шаге выбора

При автовыборе WP-подключения (шаг 2, 1 подключение) — HEAD-запрос (~1 сек). Если недоступен — сразу ошибка (§8.2).

### 10.7. Pipeline checkpoint vs FSM timeout

Pipeline checkpoint (TTL 24h) **полностью независим от FSM inactivity timeout** (30 мин). Даже если FSM сбросился — checkpoint жив.

---

## 11. UX-решения

### 11.1. Pipeline заменяет Quick Publish

Pipeline **полностью заменяет** Quick Publish. Quick Publish удалён.

### 11.2. Pipeline = онбординг

Отдельный onboarding wizard не нужен. При первом запуске pipeline проводит через создание проекта → WP → категорию → ключевики → публикацию.

### 11.3. Навигационные заголовки

Каждое сообщение pipeline начинается с компактного заголовка в формате `(N/5)`:

```
"Статья (1/5) — Проект"          — выбор проекта
"Статья (2/5) — Сайт"            — проверка/подключение WP
"Статья (3/5) — Тема"            — выбор категории
"Статья (4/5) — Подготовка"      — readiness чеклист
"Статья (5/5) — Подтверждение"   — финальное подтверждение
"Статья — Генерация..."          — процесс (без номера)
"Статья — Превью"                — предпросмотр (без номера)
```

### 11.4. Упрощение ключевиков для новичка

```
"Подберём SEO-фразы для лучшего ранжирования?

 [Подобрать автоматически (100 фраз — 100 токенов)]
 [Настроить параметры]
 [Пропустить]"
```

`[Подобрать автоматически]` использует `company_name` + `specialization`. 1 нажатие вместо 3 шагов.

### 11.5. Post-publish подсказки

Ненавязчивые подсказки после публикации, показываются один раз:

| После | Подсказка |
|-------|-----------|
| 1-й публикации | «Добавьте описание компании — статьи будут точнее» |
| 3-й публикации (нет цен) | «Добавьте прайс-лист — в статьях появятся реальные цены» |
| 5-й публикации (нет расписания) | «Настройте автопубликацию — бот будет работать пока вы отдыхаете» |

### 11.6. Автогенерация описания при пропуске

Если пользователь пропустил описание, AI использует доступный контекст:
`company_name` + `specialization` + `website_url`.

### 11.7. >8 проектов (power user)

```
"Для какого проекта?"

[Мебель Комфорт]  ← последний использованный
[Стоматология]    ← предпоследний
──────────────────
[Автосервис]  [Детский сад]  ...
[Ещё ▼]
```

Последний использованный — первым в списке.

### 11.8. GOD_MODE в pipeline

Для `ADMIN_ID`:
- Токены **не списываются**
- Стоимость отображается: `"Стоимость: ~320 ток. (GOD_MODE — бесплатно)"`

### 11.9. Pipeline analytics (Phase D)

Таблица `pipeline_events(user_id, pipeline_id, event, step, metadata, created_at)` для трекинга воронки.

### 11.10. Demo-статья (Phase D)

Кнопка `[Посмотреть пример статьи]` на Dashboard для новичков — Telegraph-превью, 0 токенов. Исчезает после первой публикации.

### 11.11. Batch mode (Phase D)

Пакетная генерация — выбор нескольких категорий → генерация N статей.

---

## 12. ButtonStyle карта — Pipeline

### 12.1. Стратегия

| Стиль | Цвет | Семантика | Макс. на экран |
|-------|------|-----------|----------------|
| `PRIMARY` | Синий | Главный CTA, точка входа | 1 |
| `SUCCESS` | Зелёный | Подтверждение, необратимое действие | 1 |
| `DANGER` | Красный | Потеря данных/токенов/прогресса | 1 |
| *(без стиля)* | Дефолт | Навигация, выбор, enrichers | Без ограничений |

### 12.2. Карта по экранам

#### Dashboard (§2)

| Кнопка | Style | Почему |
|--------|-------|--------|
| `[Написать статью на сайт]` | `PRIMARY` | Главная точка входа |
| `[Создать пост в соцсети]` | — | Вторичный CTA |
| `[Мои проекты]` `[Профиль]` `[Токены]` | — | Навигация |

#### Article Pipeline — Шаг 2: WordPress

| Кнопка | Style |
|--------|-------|
| `[Подключить WordPress]` | `PRIMARY` |
| `[Только превью]` | — |

#### Article Pipeline — Шаг 4: Readiness

| Кнопка | Style |
|--------|-------|
| `[Подобрать ключевики]` `[Описание]` `[Цены]` | — |
| **`[Всё ОК — генерировать →]`** | `SUCCESS` |
| `[Сохранить]` (в sub-flow) | `SUCCESS` |
| `[Перегенерировать]` (в sub-flow) | — |

#### Article Pipeline — Шаг 5: Подтверждение

| Кнопка | Style |
|--------|-------|
| **`[Создать статью]`** | `SUCCESS` |
| `[Вернуться к чеклисту]` | — |
| `[Отмена]` | — |

#### Article Pipeline — Шаг 7: Превью

| Кнопка | Style |
|--------|-------|
| **`[Опубликовать]`** | `SUCCESS` |
| `[Перегенерировать]` | — |
| `[Отмена — вернуть токены]` | `DANGER` |

#### Article Pipeline — Шаг 8: Результат

| Кнопка | Style |
|--------|-------|
| `[Ещё статью]` | `PRIMARY` |
| `[Настроить автопубликацию]` `[Главное меню]` | — |

#### Social Pipeline — Шаг 2: Подключение

| Кнопка | Style |
|--------|-------|
| Кнопки подключений | — |
| `[Подключить Telegram/VK/Pinterest]` | — |

#### Social Pipeline — Шаг 5-6: Подтверждение/Ревью

| Кнопка | Style |
|--------|-------|
| **`[Создать пост]`** / **`[Опубликовать]`** | `SUCCESS` |
| `[Перегенерировать]` | — |
| `[Отмена]` / `[Отмена — вернуть токены]` | `DANGER` |

#### Social Pipeline — Шаг 7: Результат

| Кнопка | Style |
|--------|-------|
| `[Адаптировать для VK/Pinterest]` | — |
| `[Ещё пост]` | `PRIMARY` |

#### Ошибки (§8)

| Экран | Кнопка | Style |
|-------|--------|-------|
| Нехватка токенов | `[Пополнить баланс]` | `PRIMARY` |
| Возврат после оплаты | `[Продолжить]` | `SUCCESS` |
| WP недоступен | `[Повторить попытку]` | `PRIMARY` |
| Генерация fail | `[Повторить]` | `PRIMARY` |

#### Защита от выхода (§8.5)

| Кнопка | Style |
|--------|-------|
| **`[Продолжить pipeline]`** | `PRIMARY` |
| `[Выйти в меню]` | `DANGER` |

#### Предложение расписания (§7.1)

| Кнопка | Style |
|--------|-------|
| `[Каждый будний день]` / `[Пн, Ср, Пт]` | — |
| `[Настроить вручную]` `[Позже]` | — |

> **Примечание:** Пресеты расписания — обратимые (можно удалить), поэтому без стиля.
> SUCCESS применяется только к кнопке [Готово] после ручной настройки (необратимое создание cron).

#### Возобновление pipeline (§2.6)

| Кнопка | Style |
|--------|-------|
| **`[Продолжить]`** | `SUCCESS` |
| `[Начать заново]` | — |
| `[Отменить]` | `DANGER` |

#### Кросс-постинг ревью (§6.2)

| Кнопка | Style |
|--------|-------|
| **`[Опубликовать в VK]`** | `SUCCESS` |
| `[Отмена]` | — |

#### Прерывание pipeline (§8.7)

| Кнопка | Style |
|--------|-------|
| `[Прервать и начать новый]` | `DANGER` |
| **`[Вернуться к текущему]`** | `PRIMARY` |

### 12.3. Сводная статистика

```
SUCCESS (зелёный): ~20 кнопок — "деньги → результат" или "проблема → решение"
PRIMARY (синий):    ~8 кнопок — точки входа и "безопасный выбор"
DANGER  (красный):  ~6 кнопок — потеря контента / прогресса / токенов
Без стиля:        ~60 кнопок — навигация, выбор, enrichers
```

### 12.4. Правила для разработчика

1. **Максимум 1 `PRIMARY` на экране.** Если есть `SUCCESS` — `PRIMARY` не нужен
2. **`SUCCESS` только для необратимых действий:** списание, публикация, сохранение
3. **`DANGER` только при потере:** контента, прогресса, токенов
4. **Enrichers всегда без стиля:** ключевики, описание, цены
5. **`icon_custom_emoji_id`:** не используем в v2

---

## 13. Навигационная карта — Pipeline

```
/start (Dashboard)
 │
 Reply-KB: [Меню] [Написать статью] [Создать пост] [АДМИНКА]*
 │
 Inline-KB:
 ├──[Написать статью (PRIMARY)]
 │   ├──[Проект] (0→создать, 1→авто, >1→список)
 │   ├──[WordPress] (0→подключить/превью, 1→авто, >1→список)
 │   ├──[Категория] (0→создать, 1→авто, >1→список)
 │   ├──[Readiness чеклист]
 │   │   ├── Ключевики (авто/настроить/загрузить)
 │   │   ├── Описание (AI/вручную)
 │   │   ├── Цены (текст/Excel)
 │   │   └── Изображения (AI/количество)
 │   ├──[Подтверждение]
 │   ├──[Генерация] (прогресс-сообщения)
 │   ├──[Превью] (Telegraph) → [Опубликовать] / [Перегенерировать] / [Отмена]
 │   └──[Результат] → [Ещё статью] / [Автопубликация] / [Меню]
 │
 ├──[Создать пост в соцсети]
 │   ├──[Проект]
 │   ├──[Подключение] (конкретные каналы/группы)
 │   ├──[Категория]
 │   ├──[Readiness] (сокращённый: ключевики + описание)
 │   ├──[Подтверждение]
 │   ├──[Ревью] (текст поста в чате) → [Опубликовать] / [Перегенерировать] / [Отмена]
 │   └──[Результат] → [Кросс-пост VK/Pinterest] / [Ещё пост] / [Меню]
 │       └── Кросс-пост → [Ревью адаптации] → [Опубликовать] / [Отмена]
 │
 ├──[Мои проекты] → UX_TOOLBOX.md
 ├──[Профиль] → UX_TOOLBOX.md §14
 └──[Токены] → UX_TOOLBOX.md §15
```
