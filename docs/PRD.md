# SEO Master Bot v2 — Документ требований к продукту (PRD)

> **Версия:** 2.0
> **Дата:** 12 февраля 2026
> **Статус:** Черновик на ревью
> **На основе:** BUSINESS_LOGIC_SPEC.md, AUDIT_AND_ROADMAP.md, AI_MODULE_ANALYSIS.md, HOW_SITE_FEATURES_WORK.md
>
> **Связанные документы:**
> - [ARCHITECTURE.md](ARCHITECTURE.md) — техническая архитектура, БД-схема, структура проекта
> - [API_CONTRACTS.md](API_CONTRACTS.md) — QStash, Stars flow, rate limits, сервисные контракты, промпты, ротация фраз
> - [FSM_SPEC.md](FSM_SPEC.md) — FSM-состояния, валидация ввода
> - [EDGE_CASES.md](EDGE_CASES.md) — edge cases (E01-E42), обработка ошибок, валидация контента
> - [USER_FLOWS_AND_UI_MAP.md](USER_FLOWS_AND_UI_MAP.md) — все экраны, навигация, FSM-мастера
>
> **История версий:**
> - v1.0: Первичная версия PRD
> - v1.1: Упрощение онбординга (14→4 вопроса), DataForSEO/Serper, упрощение настроек изображений/Schema.org, текстовый ввод прайсов, интеграция аудита в воронку
> - v1.2: Telegraph-превью, отзывы за feature flag, наследование настроек от категории, быстрая публикация, обогащение AI-промпта данными PSI/DataForSEO/цветами, медиа как контекст, компактный вывод фраз
> - v1.3: Aiogram 3.25+, DeepSeek V3.2, Stars подписки, ЮKassa, Firecrawl unified billing, UX-навигация, единая БД-схема, QStash webhook, FSM-валидация, edge cases, rate limits
> - v1.4: P99 уточнение, стратегия Stars+ЮKassa, критерии выбора бюджетной модели, валидация контента при автопубликации, уведомления о пропущенных автопубликациях, реферальная система для Stars, FSM `publishing`, вычистка терминологии
> - **v2.0: Реструктуризация документации. Техническая архитектура → ARCHITECTURE.md, edge cases → EDGE_CASES.md. PRD теперь содержит только продуктовые требования**

---

## 1. Краткое описание

SEO Master Bot v2 — полная переписка существующего Telegram-SaaS для автоматизированного создания и мультиплатформенной публикации SEO-контента. Переписка решает критические архитектурные проблемы (382 обработчика в плоской структуре, состояние в памяти, синхронная блокировка, нет резервной AI-модели) при сохранении 100% текущей бизнес-логики и добавлении стратегических возможностей через делегирование на внешние API.

**Основная ценность продукта:** Один Telegram-бот, который генерирует, планирует и публикует SEO-оптимизированный контент (статьи, посты в соцсети, изображения) на WordPress, Telegram, VK и Pinterest — на базе мульти-модельного AI с автоматическим переключением при сбоях.

---

## 2. Цели и метрики успеха

### 2.1 Продуктовые цели

| Цель | Метрика | Целевое значение |
|------|---------|-----------------|
| Надежность | Аптайм | 99.9% (сейчас ~80%) |
| Производительность | Время ответа P99 (UI-действия) | < 200мс (сейчас 5-30с). AI-генерация — отдельно (секция 10.1) |
| Масштабируемость | Одновременных пользователей | 1000+ (сейчас ~10) |
| Качество AI | SEO-оценка статей | 90+ / 100 (сейчас ~70) |
| Скорость разработки | Время добавления новой платформы | 1 день (сейчас 1 месяц) |
| Сохранность состояния | Потеря данных при рестарте | Ноль (сейчас полная потеря) |

### 2.2 Бизнес-цели

| Метрика | 3 месяца | 6 месяцев | 12 месяцев |
|---------|----------|-----------|------------|
| MAU (активных пользователей/мес) | 100 | 500 | 2 000 |
| Платящих пользователей | 20 | 100 | 400 |
| MRR (руб.) | 100К | 500К | 2М |
| Отток | < 15% | < 10% | < 8% |

---

## 3. Портреты пользователей

### 3.1 SEO-специалист-одиночка (основной)
- 1-5 клиентских сайтов
- Нужен автоматический контентный конвейер
- Чувствителен к цене, ценит прозрачность токеновой экономики
- Использует: генерацию статей, автопубликацию, генерацию ключевых фраз

### 3.2 Небольшое digital-агентство (вторичный)
- 5-20 клиентских проектов
- Нужно управление несколькими проектами одновременно
- Ценит: массовые операции, стабильное качество, white-label
- Использует: все фичи, большие объемы

### 3.3 Владелец интернет-магазина (третичный)
- 1 сайт + каналы в соцсетях
- Нужны описания товаров, посты в соцсети, пины в Pinterest
- Ценит: простоту, скорость, окупаемость
- Использует: посты в соцсети, Pinterest, описания товаров

---

## 4. Инвентаризация фич (текущая бизнес-логика)

### 4.1 Основные фичи — СОХРАНЯЕМ КАК ЕСТЬ (на новом стеке)

Эти фичи сохраняются с идентичной бизнес-логикой, переимплементированные на новой архитектуре.

| # | Фича | Описание | Приоритет |
|---|------|----------|-----------|
| F01 | Регистрация и онбординг | /start, 1500 приветственных токенов, автоязык `ru` | P0 |
| F02 | Управление проектами | Создание (быстрый старт: 4 поля, остальные 11 — в редактировании), удаление, список с пагинацией | P0 |
| F03 | Управление категориями | CRUD, описание, ключевые фразы, медиа, цены, отзывы | P0 |
| F04 | Токеновая экономика | Проверка баланса до генерации, списание после валидации, авто-возврат при ошибке | P0 |
| F05 | Пакеты токенов и биллинг | 5 тарифов (1К-50К), бонусные токены, 1 токен = 1 руб. | P0 |
| F06 | AI-генерация текста (соцсети) | Платформо-специфичные посты для TG/VK/Pinterest с настройками стиля | P0 |
| F07 | AI-генерация статей (сайт) | Полные SEO-статьи (1500-2500 слов, H1-H3, FAQ, Schema.org) | P0 |
| F08 | AI-генерация изображений | Платформо-специфичные изображения с настраиваемыми стилями/камерами/ракурсами | P0 |
| F09 | Data-first ключевые фразы + кластеризация | DataForSEO suggestions → AI кластеризация по интенту → обогащение (volume, difficulty, CPC). Одна статья = один кластер | P0 |
| F10 | Автопубликация и планировщик | Cron-подобное: дни + время + частота, для каждой категории и платформы | P0 |
| F11 | Публикация на WordPress | REST API: статья + 4 изображения + featured_media + SEO мета | P0 |
| F12 | Публикация в Telegram | Через бот-публикатор пользователя (отдельный бот от BotFather, добавлен админом в канал). HTML-пост + изображение, обработка длинных подписей | P0 |
| F13 | Публикация в VK | Прямой токен (vkhost.github.io) в v2, OAuth PKCE — бэклог. wall.post, загрузка фото, поддержка групп | P0 |
| F14 | Публикация в Pinterest | OAuth, создание пина с base64-изображением, выбор доски | P0 |
| F15 | Управление подключениями | Добавление/удаление/валидация подключений, глобальная проверка уникальности | P0 |
| F16 | Настройки контента по платформам | Формат/стиль/камера/ракурс/качество/тон изображений, стили текста, HTML-шаблоны, объём | P0 |
| F17 | Генерация отзывов *(экспериментальная)* | 3/5/10 отзывов, распределение рейтингов. Без Schema.org Review-разметки. За feature flag, легко отключаемо | P2 |
| F18 | Профиль пользователя | Дашборд баланса, прогноз расходов, история транзакций | P1 |
| F19 | Реферальная система | Ссылки ref_{user_id}, 10% от покупок приглашенных | P1 |
| F20 | Админ-панель | Дашборд, статистика, мониторинг, рассылка, расходы на API | P1 |
| F21 | Уведомления и рассылки | Приветствие, низкий баланс, еженедельные новости, реактивация | P1 |
| F22 | Настройки пользователя | Переключатели уведомлений, ссылка на поддержку, о боте | P2 |
| F23 | Медиа-галерея | Загрузка фото/видео/документов, AI-генерация изображений | P1 |
| F24 | Прайс-листы | Текстовый ввод в боте + загрузка Excel как альтернатива, цены в статьях | P2 |
| ~~F25~~ | ~~Telegram-топики~~ | ~~Убрано из v2 — избыточная сложность~~ | — |

### 4.2 Фичи — УЛУЧШАЕМ через внешние API

Эти фичи существуют, но сломаны или ограничены. Делегируем на внешние API.

| # | Фича | Текущее состояние | Новый подход | API |
|---|------|-------------------|--------------|-----|
| F26 | Определение цветов сайта | СЛОМАНО (код есть, нигде не вызывается, всегда None) | Firecrawl Branding Format v2 | Firecrawl |
| F27 | Краулинг сайта (внутренние ссылки) | Работает, но СИНХРОННО (блокирует 60с, макс 50 страниц) | Firecrawl Crawl + Map эндпоинты | Firecrawl |
| F28 | Технический аудит сайта | Базовый (7 проверок, оценка 0-10, не сохраняется) | Google PageSpeed Insights API + Firecrawl | Google PSI |
| F29 | Маршрутизация AI-моделей | Захардкожен Claude Sonnet, нет резервной модели | OpenRouter SDK с цепочкой резервных моделей | OpenRouter |
| F30 | SEO-аудит | ЗАГЛУШКА ("в разработке") | Объединён с F28: технический + SEO аудит в едином экране [Анализ сайта]. PageSpeed + Firecrawl /extract | Firecrawl + Google |
| F31 | Ключевые фразы без реальных данных | AI генерирует "из головы", нет объема поиска/сложности | DataForSEO data-first: keyword_suggestions + related → AI кластеризация → enrich | DataForSEO |
| F32 | Web Search в статьях | Предусмотрено, но сломано | Serper API: актуальные данные Google для промпта статьи | Serper |

### 4.3 Фичи — НОВЫЕ (добавлены в v2)

| # | Фича | Описание | Приоритет |
|---|------|----------|-----------|
| F33 | Оплата через Telegram Stars | Нативные платежи внутри Telegram (валюта: XTR) | P0 |
| F34 | AI-стриминг | Генерация статьи в реальном времени видна пользователю | P1 |
| F35 | Авто-исправление ответов AI | Автоматическая починка битого JSON от AI-моделей | P0 |
| F36 | Версионирование промптов | YAML-промпты с версионированием (A/B deferred to v3) | P1 |
| F37 | FSM-состояние в Redis | Персистентное состояние пользователя через перезагрузки | P0 |
| F38 | Ограничение частоты запросов | Token-bucket на пользователя в Redis | P0 |
| F39 | Анализ конкурентов | Firecrawl /extract для анализа сайтов конкурентов | P2 |
| F40 | Telegraph-предпросмотр статей | Генерация → превью на telegra.ph → [Опубликовать] / [Перегенерировать] / [Отмена] | P0 |
| F41 | Наследование настроек контента от категории | Настройки изображений/текста задаются на уровне категории, переопределяются на уровне платформы | P1 |
| F42 | Быстрая публикация в 1 клик | Главное меню → "Быстрая публикация": список "Проект: Категория → Платформа", одно нажатие = генерация | P1 |
| F43 | Медиа пользователя как контекст для AI | Загруженные фото товаров передаются в промпт — AI генерирует картинки в похожем стиле. Автопостинг не зависит от наличия медиа | P2 |
| F44 | Компактный вывод ключевых фраз | Топ-10 в чат (объём + сложность), полный список — файл TXT/CSV | P1 |
| F45 | ~~Мониторинг изменений контента~~ | Отложено до v3. Firecrawl change tracking для мониторинга конкурентов. В v2 спецификация отсутствует | P3 |
| F46 | Помощь (встроенная справка) | Разделы: первое подключение, создание проекта, категории, публикация. Доступ из главного меню | P1 |

---

## 5. Стратегия делегирования на внешние API

### 5.1 Firecrawl API — Что делегируем

Firecrawl заменяет 3 самописных, сломанных/ограниченных компонента промышленными альтернативами.

#### 5.1.1 Извлечение брендинга сайта (заменяет сломанный site_colors_detector.py)

**Текущая проблема:** Парсер на 183 строки, который читает только inline `<style>` блоки. Нигде не вызывается из UI. Всегда возвращает None. Не обрабатывает Tailwind, CSS-переменные, внешние стили.

**Решение через Firecrawl:** Эндпоинт Branding Format v2.

```python
# Один API-вызов заменяет 183 строки сломанного кода
result = firecrawl.scrape(
    url='https://сайт-клиента.ru',
    formats=['branding']
)
branding = result['branding']
# Возвращает: цветовую схему, шрифты, типографику, UI-спеки, URL логотипа
```

**Что получаем:**
- Цветовая система: основной, фоновый, акцентный цвета, цвет текста
- Типографика: семейства шрифтов, размеры, межстрочные интервалы
- UI-спеки: стили кнопок, стили полей ввода
- Брендовые ассеты: URL логотипа, URL фавикона

**Влияние на генерацию статей:** Статьи будут стилизованы под реальные цвета сайта клиента, а не под захардкоженные дефолты (#fff/#333/#0066cc).

**Стоимость:** 1 кредит за скрейп (~$0.001 на тарифе Standard). Разово при подключении сайта.

#### 5.1.2 Краулинг сайта и внутренние ссылки (заменяет utils/site_crawler.py)

**Текущая проблема:** Синхронный BFS-краулер, блокирует обработчик на 60 секунд, максимум 50 страниц, базовые приоритеты, нет JS-рендеринга, полностью пропускает SPA.

**Решение через Firecrawl:** Эндпоинты Crawl + Map (асинхронные, с JS-рендерингом, до тысяч страниц).

```python
# Асинхронный краулинг — не блокирует бота
job = firecrawl.crawl(
    url='https://сайт-клиента.ru',
    params={
        'limit': 100,
        'scrapeOptions': {
            'formats': ['markdown', 'links']
        }
    }
)
```

**Улучшения по сравнению с текущим:**
- JS-рендеринг (обрабатывает React/Vue/Next.js сайты)
- Не блокирует обработчик (асинхронная задача с поллингом)
- Лучшее обнаружение ссылок (следует по динамическим маршрутам)
- До 100+ страниц вместо текущих 50
- Обход анти-бот защиты (встроенные ротирующиеся прокси)

**Стоимость:** 1 кредит за обнаруженную страницу. 100 страниц = 100 кредитов = ~$0.08 на тарифе Standard.

#### 5.1.3 Извлечение структурированных данных — НОВАЯ возможность (анализ конкурентов, SEO-данные)

**Текущее состояние:** Анализа конкурентов нет вообще. SEO-аудит — заглушка.

**Решение через Firecrawl:** Два эндпоинта для разных сценариев:

1. **F39 (standalone-анализ конкурентов):** `/extract` — структурированные SEO-данные (мета-теги, заголовки, количество страниц)
2. **Пайплайн статей v6:** `/scrape` — полный markdown контента конкурентов для gap-анализа и динамической длины

```python
# F39: Извлечение SEO-структуры конкурента (standalone)
result = firecrawl.extract(
    urls=['https://конкурент.ru/*'],
    prompt='Извлеки все заголовки страниц, мета-описания, H1-теги и ключевые слова',
    schema={...}
)

# Article v6: Полный контент конкурента (для gap-анализа)
result = firecrawl.scrape(url='https://конкурент.ru/статья', formats=['markdown'])
```

**Сценарии использования:**
1. **SEO-аудит конкурентов** (F39, `/extract`) — анализ мета-тегов, заголовков, структуры контента конкурентов
2. **Контентный gap-анализ** (article v6, `/scrape`) — полный markdown для сравнения покрытия тем
3. **Извлечение цен** (F39, `/extract`) — парсинг цен конкурентов со страниц товаров
4. **Сбор отзывов** (F39, `/extract`) — сбор реальных отзывов с Google/Яндекс для обучающих данных

**Стоимость:** Unified billing (анонсировано на фев. 2026, проверить при старте разработки) — /extract использует общий пул кредитов. Типичное извлечение: 50-200 кредитов.

#### 5.1.4 Прогноз расходов на Firecrawl

| Операция | Частота | Кредитов/операция | Кредитов/мес | Стоимость/мес (тариф Standard $83) |
|----------|---------|-------------------|--------------|-------------------------------------|
| Извлечение брендинга | 50 новых сайтов/мес | 1 | 50 | < $0.05 |
| Краулинг сайта (100 стр) | 50 сайтов/мес | 100 | 5 000 | ~$4.15 |
| Анализ конкурентов | 20 анализов/мес | 200 | 4 000 | ~$3.33 |
| Извлечение SEO-данных | 100 извлечений/мес | 50 | 5 000 | ~$4.15 |
| **Итого** | | | **14 050** | **~$11.68** |

Тариф Standard (100К кредитов/$83) покрывает наши потребности с запасом в 86К кредитов. Даже тариф Hobby (3К кредитов/$16) покрывает MVP.

### 5.2 Google PageSpeed Insights API — Технический аудит

**Текущая проблема:** Самописный аудит проверяет только 7 базовых метрик (HTTP-статус, SSL, скорость, H1, title, meta desc, viewport). Нет Core Web Vitals. Не сохраняется. Не используется в генерации контента.

**Решение через Google PSI:** Бесплатный API, 25 000 запросов/день.

**Что получаем бесплатно:**
- Core Web Vitals (LCP, INP, CLS) + TTFB
- Оценка производительности (0-100, Lighthouse)
- Оценка доступности
- SEO-оценка
- Оценка лучших практик
- Конкретные рекомендации с приоритетами
- Анализ для мобильных + десктопа

**Стоимость:** БЕСПЛАТНО. 25К запросов/день.

**План интеграции:**
1. Запускать PSI-аудит автоматически при подключении сайта пользователем
2. Сохранять результаты в таблице `site_audits`
3. Показывать подробный отчет с практическими рекомендациями
4. Использовать данные о производительности для оптимизации HTML статей (ленивая загрузка изображений, минимальный CSS)

### 5.3 OpenRouter SDK — Маршрутизация AI-моделей

**Текущая проблема:** Захардкожен `claude-sonnet-4-20250514`, нет резервной модели, нет выбора модели, нет стриминга.

**Решение через OpenRouter:** 50+ моделей, автоматическая маршрутизация, встроенное резервирование.

| Задача | Роль модели | Текущий кандидат (фев. 2026) | Резервная | Критерии выбора |
|--------|------------|------------------------------|-----------|-----------------|
| SEO-статьи | Премиум | Claude 4.5 Sonnet | GPT-5.2 | Качество длинных текстов (2000+ слов), следование структуре H1-H3 |
| Посты в соцсети | Бюджетная | DeepSeek V3.2 ($0.25/M input, $0.38/M output) | Claude 4.5 Sonnet | Цена < $1/M tokens, качество коротких текстов (200-500 слов) |
| Ключевые фразы | Бюджетная | DeepSeek V3.2 | GPT-5.2 | Цена < $1/M, способность генерировать структурированные списки |
| Генерация изображений | Премиум | Nano Banana Pro (Gemini 3 Pro Image) | Nano Banana (Gemini 2.5 Flash Image) | Качество + multimodal reasoning, всё через OpenRouter |
| Анализ конкурентов | Аналитическая | GPT-5.2 | Claude 4.5 Sonnet | Точность извлечения данных из HTML |
| Генерация отзывов | Бюджетная | DeepSeek V3.2 | Claude 4.5 Sonnet | Цена < $1/M, экспериментальная фича |

> **Примечание:** Конкретные модели и цены актуальны на фев. 2026. При запуске выбрать бюджетную модель по критерию: цена < $1/M tokens + приемлемое качество на бенчмарке коротких текстов. OpenRouter позволяет сменить модель в конфиге без изменения кода.

**Ключевые возможности OpenRouter (используемые в проекте):**
- **Model Fallbacks** — нативная цепочка `models: [primary, secondary, ...]`, автопереключение при ошибке/таймауте/модерации. Оплата только за модель, которая ответила
- **Provider Routing** — `sort: "price"` для бюджетных задач, `sort: "throughput"` для стриминга, `data_collection: "deny"` для приватности
- **Structured Outputs** — `response_format: {type: "json_schema", strict: true}` для типобезопасных ответов (keywords, articles, reviews), гарантия валидного JSON
- **Response Healing plugin** — нативная автопочинка сломанного JSON (non-streaming), дополнение к нашему heal_response
- **Prompt Caching** — автоматическое (OpenAI, DeepSeek) и ручное (`cache_control` для Claude) кеширование system-промптов, экономия 50-75% на input tokens при автопубликации
- **Streaming (SSE)** — `stream: true` для генерации статей в реальном времени
- **Image Generation** — модальность `["image", "text"]` для Nano Banana (Gemini) моделей
- Единый биллинг через один API-ключ, 0% markup на инференс (5.5% на покупку кредитов)

**Возможности OpenRouter, зарезервированные на будущее:**
- **Web Search plugin** (`:online` суффикс) — альтернатива/дополнение к Serper для актуальных данных
- **Reasoning tokens** (`reasoning.effort: "high"`) — для сложных SEO-аудитов и аналитики конкурентов
- **ZDR (Zero Data Retention)** — `provider.zdr: true` для клиентов с требованиями к конфиденциальности
- **Guardrails** — бюджетные лимиты на уровне API-ключа (daily/weekly/monthly caps)

> Технические детали реализации (SDK init, fallback config, structured outputs, prompt caching, streaming) → см. [API_CONTRACTS.md](API_CONTRACTS.md) §3.1

### 5.4 Telegram Stars — Нативные платежи

**Текущая проблема:** Платежная система — заглушка. Интеграции нет.

**Решение через Telegram Stars:** Встроенная платежная система, не нужен внешний платежный провайдер.

- Валюта: XTR (Telegram Stars)
- Не нужна интеграция ЮKassa/Stripe
- Пользователи покупают Stars через Apple Pay/Google Pay
- Бот отправляет инвойс через `sendInvoice` с `provider_token=""`
- **Подписки (Bot API 9.4):** `subscription_period` = 30 дней, автосписание Stars
- Вывод средств: платформа Fragment → Toncoin → фиат (мин. 1000 Stars, заморозка 21 день)

**Комиссии и экономика Stars:**
- Apple/Google: **30%** от покупки Stars (15% для малого бизнеса)
- Telegram: **~5%** административных расходов
- Курс вывода: **$0.013/Star** (~1.30 руб)
- Пользователь платит ~2 руб/Star → разработчик получает ~1.30 руб → **потери ~35%**
- Экономия для пользователей: покупка Stars через Fragment/TON до 40% дешевле App Store

**Модель монетизации: разовые пакеты + подписки.**
Подписки через Stars (30 дней, автопродление) для регулярных пользователей. Разовые пакеты для пробных покупок.

**Стратегия платежей (Stars + ЮKassa):**
- **Stars — основной по UX:** нативный (0 кликов вне Telegram), конверсия выше в 2-3x vs внешний эквайринг. Потери ~35%, но компенсируются объёмом конверсий.
- **ЮKassa — основной по экономике:** комиссия 3.5%, но требует редирект на внешнюю страницу оплаты. Предлагаем для крупных пакетов (Business, Enterprise), где 35% потери ощутимы.
- **UI:** на экране тарифов показываем обе кнопки: `[Оплатить Stars ⭐]` и `[Оплатить картой (ЮKassa)]`. Для пакетов от 15 000 руб. добавляем подсказку: "Экономия ~5 000 руб. при оплате картой".

> Технические детали платёжного flow → см. [API_CONTRACTS.md](API_CONTRACTS.md) §2

**Маппинг пакетов токенов на Stars:**

| Пакет | Токены | Цена (руб.) | Stars (приблизительно) |
|-------|--------|-------------|----------------------|
| Mini | 1 000 | 1 000 | ~65 Stars |
| Starter | 3 500 | 3 000 | ~195 Stars |
| Pro | 7 200 | 6 000 | ~390 Stars |
| Business | 18 000 | 15 000 | ~975 Stars |
| Enterprise | 50 000 | 40 000 | ~2 600 Stars |

**Формула расчёта Stars:** Stars ≈ price_rub / 15.38 (курс ~15.38 руб/Star на стороне пользователя). Значения в таблице округлены вниз для маркетинговой привлекательности (например, 3000/15.38 = 195.06 → указано ~195, а не ceil = 196). **Источник истины — hardcoded таблица выше.** Актуальный курс зависит от курса USD и политики Telegram; таблицу обновлять вручную.

**Подписки (автопродление Stars каждые 30 дней):**

| Подписка | Токенов/мес | Цена/мес (руб.) | Stars/мес |
|----------|-------------|-----------------|-----------|
| Pro | 7 200 | 6 000 | ~390 |
| Business | 18 000 | 15 000 | ~975 |
| Enterprise | 50 000 | 40 000 | ~2 600 |

### 5.5 DataForSEO API — реальные SEO-данные для ключевых фраз

**Текущая проблема:** AI генерирует ключевые фразы "из головы". 30-40% таких фраз имеют нулевой объём поиска. Пользователь платит за проверку мусора, а без кластеризации 4 статьи на один интент каннибализируют друг друга.

**Решение: Data-first подход + кластеризация.** Сначала DataForSEO даёт реальные фразы, затем AI кластеризует по интенту.

**Что получаем:**
- Реальные поисковые фразы (keyword_suggestions + related_keywords)
- Объем поиска, сложность, CPC для каждой фразы
- Кластеры по поисковому интенту (одна статья = один кластер, не одна фраза)
- Фильтрация: article-кластеры vs product_page-кластеры (транзакционные — не для статей)

**Пайплайн генерации ключевых фраз (data-first):**
```
1. DataForSEO keyword_suggestions(seed=specialization+city) → 200+ реальных фраз
2. DataForSEO related_keywords(top-10 фраз) → расширение семантики
3. AI кластеризует по интенту: группы фраз, главная + дополнительные
4. DataForSEO enrich_keywords → volume, difficulty, CPC для финального списка
5. Пользователь видит кластеры:

   Кластер                 | Фраз | Суммарно/мес | Сложность
   Кухни на заказ Москва   | 4    | 26 500       | Средняя
   Как выбрать кухню       | 3    | 9 800        | Низкая
   Кухни из массива дуба   | 5    | 4 200        | Низкая

6. Для автопубликации: одна статья таргетирует весь кластер
```

**Стоимость:** suggestions $0.0015 + related $0.0015 + enrich $0.0001/фраза. Полный пайплайн для 200 фраз: ~$0.025 (~2.3 руб). Бесплатно для пользователя.

**Fallback при недоступности DataForSEO (E03):** AI генерирует фразы "из головы" без кластеризации (legacy-режим). Пользователь предупреждён: "Данные без реальных объёмов поиска".

### 5.6 Serper API — актуальные данные из Google для статей

**Текущая проблема:** В бизнес-логике предусмотрен Web Search (до 3 поисковых запросов перед генерацией статьи), но реализация сломана. AI пишет статьи без актуальных данных.

**Решение через Serper:** 2 500 бесплатных запросов/мес + $0.001/запрос дальше.

**Пайплайн генерации статей (Serper + Firecrawl + AI):**
```
1. Бот берет кластер из категории (не одну фразу — см. §5.5)
2. Serper search(main_phrase) → топ-5 URL + People Also Ask + Related
3. Firecrawl /scrape → топ-3 URL → полный markdown контента:
   - Структура H2-H3 конкурентов
   - Длина статей конкурентов (для динамического расчёта объёма)
   - Темы, которые покрыты/не покрыты
4. AI анализирует конкурентов → определяет:
   - Контентные пробелы (чего нет у конкурентов → уникальная ценность)
   - Динамическую длину: median(длина конкурентов) × 1.1
5. Сборка промпта: кластер фраз + конкурентный анализ + данные бизнеса
6. AI генерирует статью, таргетирующую весь кластер
```

**Что это дает:**
- Статьи содержат актуальные факты, а не устаревшие данные из обучения AI
- FAQ генерируется из реальных вопросов пользователей Google
- Длина статьи адаптируется к конкурентам (а не захардкожена 1500-2500)
- Контентные пробелы конкурентов = уникальная ценность = лучшее ранжирование
- Кластер фраз → одна статья покрывает весь интент, а не каннибализирует

**Стоимость:** Serper бесплатно до 2 500 запросов/мес. Firecrawl /scrape: 3 кредита/статью ($0.003). При цене статьи 200 токенов (200 руб) — пренебрежимо.

### 5.7 Сводка по делегированию на API

| Компонент | Текущий (самописный) | Новый (делегированный) | Выигрыш |
|-----------|---------------------|----------------------|---------|
| Цвета сайта | 183 строки, сломано | Firecrawl Branding (1 API-вызов) | -183 строки, работает |
| Краулер сайта | 171 строка, синхронный, базовый | Firecrawl Crawl (async, JS) | -171 строка, в 10 раз лучше |
| Тех. аудит | ~200 строк, 7 проверок | Google PSI API (бесплатно, 50+ проверок) | -200 строк, в 7 раз больше проверок |
| AI-маршрутизация | Захардкожено, нет резерва | OpenRouter (50+ моделей) | Надежность 99.9% |
| Платежи | Заглушка (0 строк рабочего кода) | Telegram Stars (встроенные) | Без внешнего процессора |
| Ключевые фразы | AI-фантазии без данных | DataForSEO data-first + AI кластеризация | 90%+ фраз с реальным объёмом, без каннибализации |
| Web Search для статей | Предусмотрено, но сломано | Serper + Firecrawl /scrape (конкуренты) | Актуальные статьи, динамическая длина, контентные gaps |
| **Итого** | ~554 строки хрупкого кода | 7 API-интеграций | Промышленное качество |

---

## 6. Принципы UX: минимальная когнитивная нагрузка в чат-боте

Чат-бот — не веб-приложение. Экран маленький, клавиатура неудобная, внимание рассеяно. Каждый лишний вопрос или экран — это точка, где пользователь бросает.

**Правило 1: Максимум пользы за минимум шагов**
- Создание проекта: 4 вопроса вместо 14 (остальное — потом, если захочет)
- Подключение сайта: ввел URL + логин + пароль → всё остальное автоматом (краулинг, цвета, аудит)
- Генерация статьи: одна кнопка → готовая статья на сайте

**Правило 2: Умные дефолты и наследование**
- Изображения: пресет "Фотореализм" по умолчанию (вместо выбора из 50 параметров)
- Стиль текста: "Информативный" для сайта, "Разговорный" для соцсетей (по умолчанию)
- Schema.org: "Article" по умолчанию (не спрашиваем, если пользователь не хочет менять)
- Объём статьи: 1500-2500 слов по умолчанию (оптимум для SEO)
- Настройки контента (изображения, текст) задаются на уровне категории и наследуются всеми платформами. Переопределение для конкретной платформы — опционально

**Правило 3: Бот принимает решения за пользователя, когда может**
- Ключевые фразы сортируются по перспективности (высокий объем + низкая сложность — сверху)
- При автопубликации бот сначала берет самые перспективные фразы
- FAQ для статей берется из реальных вопросов Google (Serper), а не выдумывается AI
- Внутренние ссылки расставляются автоматически из краулинга сайта

**Правило 4: Прогрессивное раскрытие**
- Новый пользователь видит только необходимое: создать проект → категорию → опубликовать
- Продвинутые настройки (пресеты изображений, HTML-стили, Schema.org) — скрыты за кнопкой "Настройки"
- Админ-панель видна только админу

**Правило 5: Каждый экран ведет к действию**
- Нет "информационных" тупиков. Аудит сайта заканчивается предложением: "Создать контент для слабых мест?"
- Низкий баланс → кнопка "Пополнить" прямо в уведомлении
- Пустая категория → подсказка "Добавьте ключевые фразы, чтобы начать публикацию"

**Правило 6: Компактный вывод — чат не для простыней текста**
- Ключевые фразы: топ-10 в чат (с объёмом и сложностью), полный список — файл TXT/CSV по кнопке "Скачать"
- Статьи: сводка в чат (заголовок, ключевик, объём, стоимость) + ссылка на Telegraph-превью. Не 2000 слов в чате
- Аудит: 4 оценки в чат (производительность/SEO/доступность/CWV) + детали по кнопке
- Лимит Telegram — 4096 символов на сообщение. Всё, что длиннее — в файл или Telegraph

> Все экраны и навигация → см. [USER_FLOWS_AND_UI_MAP.md](USER_FLOWS_AND_UI_MAP.md)

---

## 7. Ключевые пользовательские сценарии (измененные и новые)

### 7.0 Создание проекта (упрощённый онбординг: 4 вопроса вместо 14)

**Было (v1):** 14 вопросов подряд. Пользователь жмёт "Пропустить" 13 раз. Утомительно.

**Стало (v2):** 4 ключевых вопроса на старте. Остальные 11 — в "Редактирование данных".

```
Пользователь нажимает "Создать проект"
  │
  ├── Шаг 1: {Название проекта}          ОБЯЗАТЕЛЬНО (мин. 2 символа, внутреннее имя)
  ├── Шаг 2: {Название компании}         ОБЯЗАТЕЛЬНО (используется в промптах AI)
  ├── Шаг 3: {Специализация бизнеса}     ОБЯЗАТЕЛЬНО (контекст для всего контента)
  ├── Шаг 4: {URL сайта}                 [Пропустить] (если есть — запускает авто-подключение)
  │
  └── Проект создан! Карточка проекта с подсказкой:
        "Добавьте категорию, чтобы начать публикацию"
        [Создать категорию]  [Заполнить данные компании (11 доп. полей)]
```

**Каноничный набор полей быстрого старта (единый источник истины):**
1. `project_name` — внутреннее имя для списка проектов (ОБЯЗАТЕЛЬНО)
2. `company_name` — название компании для промптов AI (ОБЯЗАТЕЛЬНО)
3. `specialization` — чем занимается компания (ОБЯЗАТЕЛЬНО)
4. `website_url` — URL сайта, если есть ([Пропустить])

**Дополнительные 11 полей** (заполняются позже в "Редактирование данных"):
`city`, `address`, `phone`, `email`, `instagram`, `vk`, `pinterest`, `telegram`, `experience`, `advantages`, `description`

**Логика:** 3 обязательных поля + 1 опциональный — это минимум, чтобы AI мог генерировать осмысленный контент. Остальное улучшает качество, но не обязательно для старта.

### 7.1 Подключение сайта (улучшено через Firecrawl)

```
Пользователь подключает WordPress-сайт
  │
  ├── Шаг 1: Ввод URL + учётных данных (как сейчас)
  ├── Шаг 2: Валидация WP REST API (как сейчас)
  ├── Шаг 3: Глобальная проверка уникальности (как сейчас)
  │
  ├── [АВТОМАТОМ в фоне — пользователь не ждёт]:
  │     ├── Firecrawl Branding → цвета, шрифты, логотип → site_brandings
  │     ├── Firecrawl Crawl → внутренние ссылки (до 100) → connections
  │     └── Google PSI → производительность, SEO, доступность → site_audits
  │
  └── Показ: "Сайт подключён!"
        + превью цветов (фон / текст / акцент)
        + оценка сайта (85/100)
        + "Обнаружено 47 внутренних ссылок — будут использоваться в статьях"
```

**Принцип:** Пользователь ввёл 3 поля — бот сделал всё остальное сам. Никаких ручных "Автосбор ссылок".

### 7.2 Генерация статьи (полный пайплайн: Serper + AI + Telegraph-превью + публикация)

```
Пользователь нажимает "Опубликовать статью"
  │
  ├── 1. Выбор ключевой фразы:
  │     Бот берёт самую перспективную по DataForSEO (высокий объём + низкая сложность)
  │
  ├── 2. Сбор данных из Google (Serper):
  │     ├── Топ-10 конкурентных статей (заголовки, структура)
  │     ├── "Люди также спрашивают" → готовые вопросы для FAQ
  │     └── Новости по теме → актуальные данные
  │
  ├── 3. Сборка промпта из ВСЕХ данных:
  │     ├── Ключевое слово + данные DataForSEO (объём, сложность, похожие фразы)
  │     ├── Данные компании + прайс + отзывы
  │     ├── Внутренние ссылки из Firecrawl
  │     ├── Цвета сайта из Firecrawl Branding → CSS inline-стили
  │     ├── Данные конкурентов + реальные вопросы из Serper
  │     └── Результаты PageSpeed (слабые стороны сайта → AI компенсирует)
  │
  ├── 4. Генерация текста:
  │     OpenRouter (Claude 4.5 Sonnet, резерв GPT-5.2)
  │     Авто-исправление если JSON битый
  │
  ├── 5. Генерация изображений:
  │     AI-генерация с цветами сайта
  │     (если в медиа-галерее есть фото товаров — AI учитывает их стиль)
  │
  ├── 6. ПРЕДПРОСМОТР (Telegraph):
  │     ├── Создание страницы на telegra.ph с текстом + картинками
  │     ├── Отправка сводки в чат:
  │     │     "Кухни на заказ в Москве: как выбрать"
  │     │     Ключевая фраза: "кухни на заказ москва" (12 400/мес)
  │     │     2 000 слов, 4 картинки, 6 заголовков H2
  │     │     ~320 токенов (200 за текст + 120 за 4 изображения)  ← пример для 2000 слов; реальная стоимость зависит от длины (270-620 токенов, см. API_CONTRACTS §5 dynamic length)
  │     │     Предпросмотр: telegra.ph/...
  │     │
  │     └── Кнопки:
  │           [Опубликовать] [Перегенерировать] [Отмена]
  │
  ├── 7а. [Опубликовать]:
  │     ├── Публикация на WordPress (с полными CSS-стилями, Schema.org, цветами сайта)
  │     ├── Удаление Telegraph-превью
  │     └── Отчёт: ссылка на сайт, списано токенов, время, модель
  │
  ├── 7б. [Перегенерировать]:
  │     ├── Новая генерация (токены НЕ списываются повторно)
  │     └── Новое Telegraph-превью
  │
  └── 7в. [Отмена]:
        ├── Токены возвращаются
        └── Telegraph-превью удаляется
```

### 7.3 Покупка токенов (Telegram Stars + ЮKassa)

```
Пользователь -> Тарифы -> Выбор пакета
  │
  ├── [Оплатить Stars ⭐]
  │     ├── Бот создает инвойс через sendInvoice(currency='XTR', prices=[...])
  │     ├── Нативное окно оплаты Telegram → подтверждение
  │     ├── Зачисление токенов + реферальный бонус
  │     └── "Зачислено {tokens} токенов! Баланс: {new_balance}"
  │
  └── [Оплатить картой (ЮKassa)]
        ├── Редирект на страницу ЮKassa
        ├── Оплата банковской картой
        ├── Колбэк → зачисление токенов
        └── Для пакетов от 15 000 руб: "Экономия ~5 000 руб. при оплате картой"
```

> Технические детали Stars/ЮKassa flow → см. [API_CONTRACTS.md](API_CONTRACTS.md) §2

### 7.4 Анализ конкурентов (НОВОЕ — Firecrawl Extract)

```
Пользователь -> Проект -> Анализ сайта -> Анализ конкурентов
  │
  ├── Ввод URL конкурента
  ├── Firecrawl /extract с SEO-схемой:
  │     - Заголовки страниц, мета-описания, H1-теги
  │     - Структура контента (секции H2, количество слов)
  │     - Паттерны ключевых слов
  │
  ├── AI-анализ: сравнение с сайтом пользователя
  ├── Результат: контентные пробелы, возможности по ключевым словам, рекомендации по структуре
  │
  └── Стоимость: 50 токенов
```

---

## 8. Продуктовые решения (разрешение пробелов)

### 8.1 Момент списания токенов и лимит перегенераций

**Правило: токены списываются в момент ГЕНЕРАЦИИ (до превью).**

```
Ручная публикация:
  1. Пользователь нажимает "Опубликовать" → подтверждение стоимости
  2. [Да, сгенерировать] → СПИСАНИЕ ТОКЕНОВ → генерация → Telegraph-превью
  3а. [Опубликовать] → публикация на платформу → отчёт
  3б. [Перегенерировать] → новая генерация БЕЗ повторного списания (макс. 2 раза)
  3в. [Отмена] → ВОЗВРАТ ТОКЕНОВ → удаление превью

Автопубликация (QStash):
  1. Проверка баланса → СПИСАНИЕ ТОКЕНОВ → генерация
  2. Валидация контента (подробности → EDGE_CASES.md)
  3. Если валидация OK → публикация → отчёт
  4. Если валидация FAIL → ВОЗВРАТ ТОКЕНОВ → уведомление пользователю
  5. Telegraph-превью НЕ создаётся (автопубликация без участия пользователя)
  6. При ошибке платформы → ВОЗВРАТ ТОКЕНОВ → уведомление пользователю

Лимит перегенераций: 2 бесплатных перегенерации на одну публикацию.
После 3-й попытки: "Перегенерировать (ещё раз, списание ~320 токенов)" — новый платный цикл.

Стоимость перегенерации: фиксируется на уровне первой генерации. Если при перегенерации AI написал 2500 слов вместо 2000 — доплата НЕ взимается. Аналогично для social posts и descriptions.
```

### 8.2 Навигация к аудиту сайта

```
Путь к аудиту:
  Карточка проекта → [Анализ сайта] → Экран анализа:
    ├── [Технический аудит (PageSpeed)] → запуск/перезапуск аудита
    ├── [Анализ конкурентов (Firecrawl)] → ввод URL конкурента
    └── [Результаты последнего аудита] → сохранённые данные
```

Кнопка `[Анализ сайта]` добавляется в карточку проекта (между "Планировщик" и "Удалить").

### 8.3 Настройки проекта vs настройки пользователя

```
"Настройки проекта" (в карточке проекта):
  ├── [Подключения платформ] → добавить/удалить WordPress/TG/VK/Pinterest для ЭТОГО проекта
  ├── [Часовой пояс] → для корректного расписания (дефолт: Europe/Moscow)
  └── [Удалить проект] → подтверждение

"Настройки" (глобальные, в главном меню):
  ├── [Уведомления] → переключатели
  ├── [Техподдержка] → контакт
  └── [О боте] → версия, информация
```

### 8.4 Текстовый ввод прайс-листа: формат

```
Формат ввода (каждый товар с новой строки):
  Название — Цена
  Название — Цена — Описание (опционально)

Примеры:
  Nike Air Max 90 — 12 990 руб
  Adidas Ultraboost — 15 490 руб — Беговые, амортизация Boost
  Puma RS-X — 8 990 руб

Парсинг: разделитель " — " (пробел-тире-пробел).
Валидация: мин. 1 товар, цена — число с возможным "руб"/"₽"/без.
Ошибка: "Не удалось распознать строку 3. Формат: Название — Цена"
```

### 8.5 VK: только прямой токен в v2

В v2 реализуем только прямой ввод токена (через vkhost.github.io). OAuth 2.1 PKCE — в бэклоге на будущее. PRD секция F13 обновлена: OAuth — как будущее улучшение.

### 8.6 CMS: только WordPress в v2

Экран "Добавить сайт" сразу показывает форму WordPress (без выбора CMS). Поддержка других CMS (Tilda, Shopify, Bitrix, Joomla) — вне скоупа v2. Instagram — вне скоупа v2.

### 8.7 Реферальная система: детали

```
- 10% от НОМИНАЛЬНОЙ СТОИМОСТИ пакета в рублях (не от токенов, не от фактической суммы оплаты)
- При оплате Stars: берётся рублёвая цена пакета из таблицы тарифов
  Пример: друг купил Starter (3000 руб / ~195 Stars) → реферер получает 300 бонусных токенов
- При оплате ЮKassa: берётся фактическая сумма платежа в рублях
  Пример: друг купил Starter за 3000 руб → реферер получает 300 бонусных токенов
- Начисление мгновенно после КАЖДОГО successful_payment (включая продления подписок)
- Глубина цепочки: 1 уровень (только прямые приглашения)
- referrer_id записывается при /start?ref_{user_id} — один раз, навсегда
- Продление подписки = реферальный бонус повторно (мотивирует привлекать долгосрочных пользователей)
```

### 8.8 Часовые пояса

Планировщик работает с часовым поясом пользователя. Дефолт: `Europe/Moscow`. Настройка: в "Настройках проекта". Хранение: поле `timezone` в таблице `projects`.

---

## 9. Токеновая экономика (обновлённая)

### 9.1 Текущие цены — СОХРАНЯЕМ

| Операция | Токены | Статус |
|----------|--------|--------|
| Генерация текста (за 100 слов) | 10 | Сохраняем |
| Генерация изображения | 30 | Сохраняем |
| Генерация ключевых фраз (50-200 шт) | 50-200 | Сохраняем (1 токен/фраза — стоимость для пользователя; DataForSEO API ~$0.025 — расход платформы) |
| Технический аудит | 50 | Сохраняем |
| Генерация отзывов (за 1 отзыв) | 10 | Сохраняем |
| Генерация описания категории | 20 | Сохраняем |

**Формула расчёта:** `токены_за_текст = ceil(word_count / 100) × 10`. Округление вверх до ближайшей сотни слов. Пример: 2000 слов → ceil(2000/100) = 20 → 20 × 10 = 200 токенов за текст. Статья 2000 слов + 4 изображения = 200 + 120 = 320 токенов. Оценка "~320 токенов" в UI — ориентировочная (до генерации точный word_count неизвестен; реальный диапазон 280-370).

**Примечание:** Социальный пост обычно составляет ~40 токенов (10 за текст 100 слов + 30 за изображение). Фактический диапазон: 40-60 токенов в зависимости от длины поста.

### 9.2 Новые операции

| Операция | Токены | Обоснование |
|----------|--------|-------------|
| SEO-анализ конкурентов | 50 | Стоимость Firecrawl /extract |
| Расширенный аудит сайта (PSI + Firecrawl) | 50 | Аналогично базовому аудиту |
| Извлечение брендинга | 0 (бесплатно) | Включено в подключение сайта |
| Краулинг внутренних ссылок | 0 (бесплатно) | Включено в подключение сайта |

### 9.3 Приветственный бонус — СОХРАНЯЕМ 1500 токенов

### 9.4 Админ (GOD MODE) — СОХРАНЯЕМ: токены не списываются, стоимость отображается

---

## 10. Нефункциональные требования

### 10.1 Производительность

| Метрика | Требование |
|---------|------------|
| Время ответа бота (нажатие кнопки) | < 200мс |
| Начало генерации статьи (стриминг) | < 3с |
| Полная генерация статьи | < 60с |
| Генерация изображения | < 15с |
| Краулинг сайта (Firecrawl) | < 30с для 100 страниц |
| Запрос к БД (P99) | < 50мс |
| Одновременных пользователей | 1000+ без деградации |

### 10.2 Надежность

| Метрика | Требование |
|---------|------------|
| Аптайм | 99.9% |
| Восстановление состояния после краша | < 5 секунд (из Redis) |
| Переключение AI | Автоматическое, < 2с |
| Потеря данных | Ноль (персистентный FSM + БД) |
| Доставка запланированных постов | 99.5% (гарантия QStash) |

### 10.3 Безопасность

| Аспект | Подход |
|--------|--------|
| Секреты | Railway Variables (шифрованные, ноль в коде) |
| API-ключи | Pydantic SecretStr (никогда не логируются) |
| Данные пользователей | Row Filtering в Repository layer (service_role key, без RLS) |
| Ограничение запросов | Token-bucket в Redis на пользователя |
| Валидация входных данных | Pydantic-модели для всех вводов |
| SQL-инъекции | Только параметризованные запросы (клиент Supabase) |

### 10.4 Наблюдаемость

| Инструмент | Назначение |
|------------|------------|
| Sentry | Отслеживание ошибок, мониторинг производительности |
| Структурированный логгинг | JSON-логи с correlation ID |
| Админ-дашборд | Статистика в реальном времени в боте |
| Дашборд QStash | Мониторинг запланированных задач |
| Дашборд Supabase | Метрики БД, мониторинг запросов |

> Техническая реализация безопасности (rate limits, env vars, шифрование) → см. [API_CONTRACTS.md](API_CONTRACTS.md) §4

---

## 11. План миграции и развертывания

> **Примечание:** Ниже — продуктовый план из 5 фаз (high-level). Детальный план разработки из 12 фаз с точной разбивкой по модулям — в `.progress/phases.md`.

### Фаза 1: Фундамент (недели 1-3)
- Настройка Railway, CI/CD пайплайн
- Pydantic Settings, миграция секретов
- Создание схемы Supabase + миграция данных
- Настройка Upstash Redis
- Интеграция Sentry

**Результат:** Инфраструктура готова, ноль данных в коде, CI/CD работает.

### Фаза 2: Ядро бота (недели 4-7)
- Aiogram 3.25 с роутерами (25 роутеров из 382 обработчиков)
- Redis FSM-хранилище
- Паттерн Repository для доступа к БД
- Все пользовательские сценарии: проекты, категории, настройки, профиль

**Результат:** Бот функционален со всеми CRUD-операциями, персистентное состояние.

### Фаза 3: AI и публикация (недели 8-11)
- Интеграция OpenRouter с цепочкой резервных моделей
- YAML-шаблоны промптов (миграция из Python-файла на 1246 строк)
- Стриминг генерации статей
- Авто-исправление ответов AI
- Все 4 паблишера: WordPress, Telegram, VK, Pinterest
- Планировщик QStash (замена APScheduler)

**Результат:** Полный конвейер генерации контента и публикации работает.

### Фаза 4: Внешние API и платежи (недели 12-14)
- Интеграция Firecrawl (брендинг, краулинг, извлечение)
- Интеграция Google PageSpeed API
- Интеграция платежей Telegram Stars
- Фича анализа конкурентов
- Токеновая экономика полностью операционна

**Результат:** Все внешние API подключены, платежи работают.

### Фаза 5: Полировка и запуск (недели 15-16)
- E2E-тестирование
- Нагрузочное тестирование (Locust: 500 одновременных пользователей)
- Завершение админ-панели
- Аудит безопасности (OWASP Top 10)
- Деплой в продакшн

**Результат:** SaaS готов к продакшну.

---

## 12. Риски и митигации

| Риск | Вероятность | Влияние | Митигация |
|------|------------|---------|-----------|
| Даунтайм OpenRouter/Claude | 5% | Высокое | Нативные fallback-цепочки OpenRouter: `models` массив для каждого типа задачи (см. API_CONTRACTS §3.1 MODEL_CHAINS) |
| Изменения API Firecrawl | 10% | Среднее | Абстрагировано за `services/external/firecrawl.py`, легко заменить |
| Потеря данных при миграции Supabase | 1% | Критическое | Пробный прогон на стейджинге, бэкап перед миграцией |
| Низкое принятие Telegram Stars | 20% | Среднее | Сохранить традиционный вариант оплаты как резервный |
| Потеря данных Redis (Upstash) | 2% | Среднее | Автоматический failover + снимки каждый час |
| Лимиты запросов Firecrawl | 5% | Низкое | Кеширование результатов, пакетные операции |
| Регрессия качества промптов | 15% | Среднее | Версионирование промптов, сохранение промпта v4 как резервного |
| Истечение VK-токена (прямой ввод) | 10% | Низкое | Уведомление пользователя о необходимости обновить токен, валидация при каждой публикации |

---

## 13. Вне рамок (v2)

Эти фичи явно НЕ включены в этот релиз:

| Фича | Причина |
|------|---------|
| Публикация в Instagram | Требует верификации Facebook Business, сложное одобрение |
| Веб-дашборд (вне Telegram) | Будущее v3, фокус на Telegram-first |
| Мультиязычный UI бота | Текущая аудитория только русскоязычная |
| AI-контент на английском/других языках | Будущее улучшение |
| Публикация на Tilda/Shopify/Bitrix/Joomla | Низкий спрос, подключения CMS сохранены на будущее |
| White-label / мульти-тенант | Будущая enterprise-фича |

---

## 14. Открытые вопросы

| # | Вопрос | Влияние | Решение нужно к |
|---|--------|---------|-----------------|
| ~~1~~ | ~~Stars + ЮKassa?~~ → **Решено: оба (секция 5.4)** | — | — |
| 2 | Firecrawl self-hosted или облако? | Стоимость при масштабировании | Начало Фазы 4 |
| ~~3~~ | ~~Выбор модели для генерации изображений~~ → **Решено: Nano Banana (Gemini) через OpenRouter (секция 5.3)** | — | — |
| 4 | Сколько расписаний QStash нужно? (тарифный план) | Стоимость инфраструктуры | Начало Фазы 3 |
| 5 | Должен ли анализ конкурентов быть отдельной платной фичей? | Монетизация | Начало Фазы 4 |

---

## 15. Приложение: Прогноз ежемесячных расходов

### Расходы на инфраструктуру (при 500 MAU)

| Сервис | Тариф | Стоимость/мес |
|--------|-------|---------------|
| Railway | Pro | $20 |
| Supabase | Pro | $25 |
| Upstash Redis | По потреблению | $10 |
| Upstash QStash | Pro | $20 |
| Firecrawl | Standard (100К кредитов) | $83 |
| DataForSEO | По потреблению (~50К запросов) | ~$5-15 |
| Serper | По потреблению (2500 бесплатных) | ~$0-10 |
| OpenRouter (AI-модели) | По потреблению | ~$1 000-1 500 (с учётом изображений ~63% бюджета) |
| Sentry | Team | $26 |
| Домен + SSL | - | $15 |
| **Итого** | | **$1 204-1 724/мес** |

### Прогноз выручки (при 500 MAU, 20% конверсия)

| | Расчет | Сумма |
|-|--------|-------|
| Платящих пользователей | 500 * 20% | 100 |
| Средний чек | Пакет Starter в среднем | 3 000 руб. (~$30) |
| Месячная выручка | 100 * $30 | **$3 000/мес** |
| Валовая маржа | ($3 000 - $1 724) / $3 000 | **~43%** (при 500 MAU; улучшается с ростом за счёт фиксированных расходов) |

---

## 16. Ссылки

- [ARCHITECTURE.md](./ARCHITECTURE.md) — Техническая архитектура (стек, структура проекта, БД-схема)
- [API_CONTRACTS.md](./API_CONTRACTS.md) — QStash, Stars flow, rate limits, сервисные контракты, промпты, ротация фраз
- [FSM_SPEC.md](./FSM_SPEC.md) — FSM-состояния, валидация ввода
- [EDGE_CASES.md](./EDGE_CASES.md) — Edge cases (E01-E42), обработка ошибок, валидация контента
- [USER_FLOWS_AND_UI_MAP.md](./USER_FLOWS_AND_UI_MAP.md) — Все экраны и навигация
- [BUSINESS_LOGIC_SPEC.md](./BUSINESS_LOGIC_SPEC.md) — Полная спецификация бизнес-логики (частично устаревшая, см. PRD)
- [AUDIT_AND_ROADMAP.md](./AUDIT_AND_ROADMAP.md) — Технический аудит и дорожная карта рефакторинга
- [AI_MODULE_ANALYSIS.md](./AI_MODULE_ANALYSIS.md) — Глубокий анализ AI-модуля
- [HOW_SITE_FEATURES_WORK.md](./HOW_SITE_FEATURES_WORK.md) — Анализ фич работы с сайтами
- [Документация Firecrawl](https://docs.firecrawl.dev/) — Документация Firecrawl API
- [Firecrawl Branding Format](https://www.firecrawl.dev/blog/branding-format-v2) — Извлечение брендинга
- [Firecrawl /extract](https://docs.firecrawl.dev/features/extract) — Извлечение структурированных данных
- [Цены Firecrawl](https://www.firecrawl.dev/pricing) — Кредитная система тарификации
- [Google PageSpeed Insights API](https://developers.google.com/speed/docs/insights/v5/get-started) — Бесплатный аудит сайтов
- [DataForSEO API](https://dataforseo.com/apis) — Реальные SEO-данные (объемы поиска, сложность)
- [Serper API](https://serper.dev/) — Google SERP в реальном времени
- [Telegraph API](https://telegra.ph/api) — Предпросмотр статей перед публикацией
- [Платежи Telegram Stars](https://core.telegram.org/bots/payments-stars) — Bot Payments API
- [OpenRouter](https://openrouter.ai/) — Мульти-модельная AI-маршрутизация
- [DeepSeek V3.2 на OpenRouter](https://openrouter.ai/deepseek/deepseek-v3.2) — Бюджетная AI-модель ($0.25-0.38/M tokens)
- [Telegram Star Subscriptions](https://core.telegram.org/api/subscriptions) — Подписки через Stars (Bot API 9.4)
- [ЮKassa](https://yookassa.ru/) — Альтернативный платёжный провайдер (комиссия 3.5%)
- [Документация Aiogram 3.x](https://docs.aiogram.dev/) — Фреймворк бота
- [Документация Supabase](https://supabase.com/docs) — База данных + авторизация
- [Upstash QStash](https://upstash.com/docs/qstash) — Бессерверное планирование
- [Upstash Redis](https://upstash.com/docs/redis) — Управляемый Redis
